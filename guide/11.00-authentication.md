# Chapter 11: Authentication

Authentication verifies user identity. In this chapter, we'll build a complete authentication system from scratch and explore Phoenix's built-in authentication generator.

## What You'll Learn

- Password hashing with Argon2/Bcrypt
- User registration
- Login and logout flows
- Remember me functionality
- Password reset via email
- Email verification
- OAuth integration

## Chapter Structure

This chapter covers:

- **11.1 Password Hashing** - Secure password storage
- **11.2 User Registration** - Creating new accounts
- **11.3 Login and Logout** - Session management
- **11.4 Remember Me** - Persistent sessions
- **11.5 Password Reset** - Email-based recovery
- **11.6 Email Verification** - Confirming email addresses
- **11.7 OAuth** - Third-party authentication

## Phoenix Authentication Generator

Phoenix provides `mix phx.gen.auth` for complete authentication scaffolding:

```bash
# Generate authentication
mix phx.gen.auth Accounts User users

# What it creates:
# - User schema and migration
# - Registration, login, logout controllers
# - Password reset functionality
# - Email confirmation
# - Session management
# - LiveView integration
```

We'll build these features manually to understand how they work.

## Authentication Flow Overview

```
Registration:
User → Submit form → Validate → Hash password → Create user → Send confirmation email

Login:
User → Submit credentials → Verify password → Create session → Set cookie

Protected Routes:
Request → Check session → Load user → Allow or redirect

Logout:
User → Clear session → Delete cookie → Redirect
```

## User Schema Preview

```elixir
defmodule Snippetbox.Accounts.User do
  use Ecto.Schema
  import Ecto.Changeset

  schema "users" do
    field :email, :string
    field :password, :string, virtual: true, redact: true
    field :hashed_password, :string, redact: true
    field :confirmed_at, :naive_datetime

    timestamps()
  end
end
```

## Authentication Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      Router Pipelines                        │
│  ┌─────────────────┐  ┌─────────────────┐                   │
│  │ fetch_session   │  │ require_auth    │                   │
│  │ fetch_user      │  │ redirect_if_    │                   │
│  │                 │  │ authenticated   │                   │
│  └─────────────────┘  └─────────────────┘                   │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      Controllers                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │ Registration    │  │ Session         │  │ Password    │ │
│  │ Controller      │  │ Controller      │  │ Controller  │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      Context (Accounts)                      │
│  • User CRUD            • Password hashing                  │
│  • Session tokens       • Email tokens                      │
│  • Authentication       • Password reset                    │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      Database                                │
│  • users table          • user_tokens table                 │
└─────────────────────────────────────────────────────────────┘
```

## Security Principles

1. **Never store plaintext passwords** - Always hash
2. **Use slow hashing algorithms** - Argon2 or Bcrypt
3. **Prevent timing attacks** - Constant-time comparisons
4. **Secure session management** - Signed tokens, rotation
5. **Protect against enumeration** - Generic error messages
6. **Require strong passwords** - Length, complexity
7. **Rate limit attempts** - Prevent brute force

Let's start with password hashing.
