# Chapter 5.6: Helpers and Formatting

View helpers transform data for display. In this chapter, we'll create helpers for common formatting tasks like dates, numbers, text, and more.

## Where to Put Helpers

### View-Specific Helpers

```elixir
# File: lib/snippetbox_web/controllers/snippet_html.ex

defmodule SnippetboxWeb.SnippetHTML do
  use SnippetboxWeb, :html

  embed_templates "snippet_html/*"

  # Snippet-specific helpers
  def language_label(language) do
    # ...
  end
end
```

### Shared Helpers

```elixir
# File: lib/snippetbox_web/helpers.ex

defmodule SnippetboxWeb.Helpers do
  @moduledoc """
  Shared view helpers available in all templates.
  """

  def format_date(datetime) do
    # ...
  end

  def truncate(text, length) do
    # ...
  end
end

# Import in lib/snippetbox_web.ex
defp html_helpers do
  quote do
    import SnippetboxWeb.Helpers
  end
end
```

## Date and Time Formatting

### Basic Date Formatting

```elixir
def format_date(nil), do: ""

def format_date(datetime) do
  Calendar.strftime(datetime, "%B %d, %Y")
end

def format_datetime(nil), do: ""

def format_datetime(datetime) do
  Calendar.strftime(datetime, "%B %d, %Y at %I:%M %p")
end

def format_date_short(nil), do: ""

def format_date_short(datetime) do
  Calendar.strftime(datetime, "%b %d, %Y")
end
```

### Relative Time

```elixir
def time_ago(nil), do: ""

def time_ago(datetime) do
  diff = DateTime.diff(DateTime.utc_now(), datetime, :second)

  cond do
    diff < 0 -> "in the future"
    diff < 5 -> "just now"
    diff < 60 -> "#{diff} seconds ago"
    diff < 120 -> "1 minute ago"
    diff < 3600 -> "#{div(diff, 60)} minutes ago"
    diff < 7200 -> "1 hour ago"
    diff < 86400 -> "#{div(diff, 3600)} hours ago"
    diff < 172800 -> "yesterday"
    diff < 604800 -> "#{div(diff, 86400)} days ago"
    diff < 1209600 -> "1 week ago"
    diff < 2592000 -> "#{div(diff, 604800)} weeks ago"
    true -> format_date(datetime)
  end
end
```

### Time Until

```elixir
def time_until(nil), do: ""

def time_until(datetime) do
  diff = DateTime.diff(datetime, DateTime.utc_now(), :second)

  cond do
    diff < 0 -> "expired"
    diff < 60 -> "in #{diff} seconds"
    diff < 3600 -> "in #{div(diff, 60)} minutes"
    diff < 86400 -> "in #{div(diff, 3600)} hours"
    diff < 604800 -> "in #{div(diff, 86400)} days"
    true -> format_date(datetime)
  end
end
```

### ISO 8601 for HTML

```elixir
def iso_date(nil), do: ""

def iso_date(datetime) do
  DateTime.to_iso8601(datetime)
end
```

Usage:

```heex
<time datetime={iso_date(@snippet.inserted_at)}>
  <%= time_ago(@snippet.inserted_at) %>
</time>
```

## Number Formatting

### Basic Number Formatting

```elixir
def format_number(nil), do: "0"
def format_number(num) when is_integer(num) do
  Number.Delimited.number_to_delimited(num, precision: 0)
end
def format_number(num) when is_float(num) do
  Number.Delimited.number_to_delimited(num, precision: 2)
end
```

### Compact Number Format

```elixir
def compact_number(nil), do: "0"
def compact_number(num) when num >= 1_000_000_000 do
  "#{Float.round(num / 1_000_000_000, 1)}B"
end
def compact_number(num) when num >= 1_000_000 do
  "#{Float.round(num / 1_000_000, 1)}M"
end
def compact_number(num) when num >= 1_000 do
  "#{Float.round(num / 1_000, 1)}K"
end
def compact_number(num), do: to_string(num)
```

### Percentage

```elixir
def percentage(value, total) when total > 0 do
  pct = Float.round(value / total * 100, 1)
  "#{pct}%"
end
def percentage(_, _), do: "0%"
```

### File Size

```elixir
def file_size(bytes) when bytes >= 1_073_741_824 do
  "#{Float.round(bytes / 1_073_741_824, 2)} GB"
end
def file_size(bytes) when bytes >= 1_048_576 do
  "#{Float.round(bytes / 1_048_576, 2)} MB"
end
def file_size(bytes) when bytes >= 1024 do
  "#{Float.round(bytes / 1024, 2)} KB"
end
def file_size(bytes), do: "#{bytes} bytes"
```

## Text Formatting

### Truncation

```elixir
def truncate(nil, _), do: ""
def truncate(text, max_length) when is_binary(text) do
  if String.length(text) > max_length do
    text
    |> String.slice(0, max_length)
    |> String.trim_trailing()
    |> Kernel.<>("...")
  else
    text
  end
end
```

### Word Truncation

```elixir
def truncate_words(nil, _), do: ""
def truncate_words(text, max_words) do
  words = String.split(text)

  if length(words) > max_words do
    words
    |> Enum.take(max_words)
    |> Enum.join(" ")
    |> Kernel.<>("...")
  else
    text
  end
end
```

### Pluralization

```elixir
def pluralize(1, singular, _plural), do: "1 #{singular}"
def pluralize(count, _singular, plural), do: "#{count} #{plural}"

# Usage:
# pluralize(1, "snippet", "snippets") => "1 snippet"
# pluralize(5, "snippet", "snippets") => "5 snippets"
```

### Title Case

```elixir
def title_case(nil), do: ""
def title_case(text) do
  text
  |> String.split()
  |> Enum.map(&String.capitalize/1)
  |> Enum.join(" ")
end
```

### Slug Generation

```elixir
def slugify(nil), do: ""
def slugify(text) do
  text
  |> String.downcase()
  |> String.replace(~r/[^a-z0-9\s-]/, "")
  |> String.replace(~r/[\s-]+/, "-")
  |> String.trim("-")
end
```

### Line Highlighting

```elixir
def highlight_line(content, line_number) do
  content
  |> String.split("\n")
  |> Enum.with_index(1)
  |> Enum.map(fn {line, num} ->
    if num == line_number do
      ~s(<span class="highlighted">#{html_escape(line)}</span>)
    else
      html_escape(line)
    end
  end)
  |> Enum.join("\n")
  |> raw()
end
```

## URL Helpers

### External Link

```elixir
def external_link(url, text) do
  assigns = %{url: url, text: text}

  ~H"""
  <a href={@url} target="_blank" rel="noopener noreferrer">
    <%= @text %>
    <svg class="external-icon" viewBox="0 0 20 20" fill="currentColor">
      <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
      <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
    </svg>
  </a>
  """
end
```

### Autolink URLs

```elixir
def autolink(text) do
  url_regex = ~r/https?:\/\/[^\s<]+/

  Regex.replace(url_regex, text, fn url ->
    ~s(<a href="#{url}" target="_blank" rel="noopener">#{url}</a>)
  end)
  |> raw()
end
```

## Code Helpers

### Syntax Highlighting Classes

```elixir
def language_class(language) do
  case language do
    "elixir" -> "language-elixir"
    "ruby" -> "language-ruby"
    "python" -> "language-python"
    "javascript" -> "language-javascript"
    "js" -> "language-javascript"
    "typescript" -> "language-typescript"
    "ts" -> "language-typescript"
    "go" -> "language-go"
    "rust" -> "language-rust"
    _ -> "language-plaintext"
  end
end
```

### Line Numbers

```elixir
def with_line_numbers(code) do
  code
  |> String.split("\n")
  |> Enum.with_index(1)
  |> Enum.map(fn {line, num} ->
    ~s(<span class="line-num">#{num}</span>#{html_escape(line)})
  end)
  |> Enum.join("\n")
  |> raw()
end
```

## Boolean Display

```elixir
def yes_no(true), do: "Yes"
def yes_no(false), do: "No"
def yes_no(nil), do: "No"

def check_mark(true), do: "✓"
def check_mark(false), do: "✗"
def check_mark(nil), do: "—"

def status_badge(true), do: ~s(<span class="badge badge-success">Active</span>) |> raw()
def status_badge(false), do: ~s(<span class="badge badge-secondary">Inactive</span>) |> raw()
```

## Conditional Formatting

```elixir
def highlight_if(text, condition) do
  if condition do
    ~s(<mark>#{html_escape(text)}</mark>) |> raw()
  else
    text
  end
end

def class_if(class, condition) do
  if condition, do: class, else: ""
end
```

## Complete Helpers Module

```elixir
# File: lib/snippetbox_web/helpers.ex

defmodule SnippetboxWeb.Helpers do
  @moduledoc """
  View helpers for formatting and display.
  """

  import Phoenix.HTML

  # Date/Time
  def format_date(nil), do: ""
  def format_date(dt), do: Calendar.strftime(dt, "%B %d, %Y")

  def time_ago(nil), do: ""
  def time_ago(datetime) do
    diff = DateTime.diff(DateTime.utc_now(), datetime, :second)
    cond do
      diff < 60 -> "just now"
      diff < 3600 -> "#{div(diff, 60)}m ago"
      diff < 86400 -> "#{div(diff, 3600)}h ago"
      diff < 604800 -> "#{div(diff, 86400)}d ago"
      true -> format_date(datetime)
    end
  end

  # Numbers
  def compact_number(n) when n >= 1_000_000, do: "#{Float.round(n/1_000_000, 1)}M"
  def compact_number(n) when n >= 1_000, do: "#{Float.round(n/1_000, 1)}K"
  def compact_number(n), do: to_string(n)

  # Text
  def truncate(nil, _), do: ""
  def truncate(text, len) do
    if String.length(text) > len do
      String.slice(text, 0, len) <> "..."
    else
      text
    end
  end

  def pluralize(1, s, _), do: "1 #{s}"
  def pluralize(n, _, p), do: "#{n} #{p}"
end
```

> **FP Concept: Pure Formatting Functions**
>
> View helpers are pure functions:
>
> ```elixir
> time_ago(datetime) → string
> truncate(text, length) → string
> ```
>
> Same input always produces same output. This makes them:
> - Easy to test
> - Easy to reason about
> - Cacheable when needed
>
> **Further Reading**:
> - [Phoenix.HTML](https://hexdocs.pm/phoenix_html/Phoenix.HTML.html)

## Summary

In this chapter, we learned:

- Date and time formatting helpers
- Number formatting (compact, file size, percentage)
- Text formatting (truncation, pluralization)
- URL and code helpers
- Boolean display helpers
- Organizing helpers in modules

This completes the Dynamic Templates chapter. In the next chapter, we'll explore Plugs and middleware.

---

## Additional Information

### Testing Helpers

```elixir
# test/snippetbox_web/helpers_test.exs

defmodule SnippetboxWeb.HelpersTest do
  use ExUnit.Case
  import SnippetboxWeb.Helpers

  describe "time_ago/1" do
    test "returns 'just now' for recent times" do
      now = DateTime.utc_now()
      assert time_ago(now) == "just now"
    end

    test "returns minutes ago" do
      past = DateTime.add(DateTime.utc_now(), -300, :second)
      assert time_ago(past) == "5m ago"
    end
  end

  describe "truncate/2" do
    test "truncates long text" do
      assert truncate("Hello World", 5) == "Hello..."
    end

    test "returns short text unchanged" do
      assert truncate("Hi", 5) == "Hi"
    end
  end
end
```
