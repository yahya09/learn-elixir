# Chapter 4.1: Setting Up PostgreSQL

Before we can store snippets in a database, we need to set up PostgreSQL. In this chapter, we'll install PostgreSQL and configure it for our Phoenix application.

## Why PostgreSQL?

Phoenix works with multiple databases through Ecto, but PostgreSQL is the default and most popular choice:

- **Production-ready**: Battle-tested at massive scale
- **Feature-rich**: JSON, full-text search, arrays, and more
- **Great Ecto support**: Best-supported adapter
- **Phoenix default**: Generated projects use PostgreSQL

## Installing PostgreSQL

### macOS (Homebrew)

```bash
# Install PostgreSQL
$ brew install postgresql@15

# Start PostgreSQL service
$ brew services start postgresql@15

# Verify installation
$ psql --version
psql (PostgreSQL) 15.4
```

### macOS (Postgres.app)

Download from https://postgresapp.com/ - provides a menubar app with easy start/stop.

### Ubuntu/Debian

```bash
$ sudo apt update
$ sudo apt install postgresql postgresql-contrib

# Start service
$ sudo systemctl start postgresql
$ sudo systemctl enable postgresql

# Verify
$ psql --version
```

### Docker

```bash
# Run PostgreSQL in Docker
$ docker run --name snippetbox-db \
    -e POSTGRES_USER=postgres \
    -e POSTGRES_PASSWORD=postgres \
    -p 5432:5432 \
    -d postgres:15

# Verify
$ docker exec -it snippetbox-db psql -U postgres -c "SELECT version();"
```

Docker Compose for development:

```yaml
# File: docker-compose.yml

version: '3.8'
services:
  db:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

```bash
$ docker-compose up -d
```

## Configuring PostgreSQL Access

### Create a User (Optional)

By default, Phoenix uses the `postgres` user. To create a dedicated user:

```bash
# Connect as postgres superuser
$ psql -U postgres

# Create user with password
postgres=# CREATE USER snippetbox WITH PASSWORD 'yourpassword' CREATEDB;

# Exit
postgres=# \q
```

### Configure pg_hba.conf (If Needed)

If you get authentication errors, check PostgreSQL's authentication configuration:

```bash
# Find config file location
$ psql -U postgres -c "SHOW hba_file;"

# Common locations:
# macOS: /usr/local/var/postgres/pg_hba.conf
# Linux: /etc/postgresql/15/main/pg_hba.conf
```

For development, ensure local connections use `md5` or `trust`:

```
# pg_hba.conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD
local   all             all                                     trust
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5
```

Restart PostgreSQL after changes:

```bash
# macOS
$ brew services restart postgresql@15

# Linux
$ sudo systemctl restart postgresql
```

## Phoenix Database Configuration

### Default Configuration

Phoenix generates database config in `config/dev.exs`:

```elixir
# File: config/dev.exs

config :snippetbox, Snippetbox.Repo,
  username: "postgres",
  password: "postgres",
  hostname: "localhost",
  database: "snippetbox_dev",
  stacktrace: true,
  show_sensitive_data_on_connection_error: true,
  pool_size: 10
```

### Configuration Options

```elixir
config :snippetbox, Snippetbox.Repo,
  # Connection
  username: "postgres",
  password: "postgres",
  hostname: "localhost",
  port: 5432,
  database: "snippetbox_dev",

  # Pool
  pool_size: 10,              # Number of connections
  pool: Ecto.Adapters.SQL.Sandbox,  # For tests

  # SSL (production)
  ssl: true,
  ssl_opts: [verify: :verify_none],

  # Timeouts
  timeout: 15_000,            # Query timeout (ms)
  connect_timeout: 10_000,    # Connection timeout (ms)

  # Logging
  log: :debug,                # Log SQL queries

  # Development helpers
  stacktrace: true,
  show_sensitive_data_on_connection_error: true
```

### Using DATABASE_URL

For production and some development setups:

```elixir
# File: config/runtime.exs

if config_env() == :prod do
  database_url = System.get_env("DATABASE_URL") ||
    raise "DATABASE_URL not set"

  config :snippetbox, Snippetbox.Repo,
    url: database_url,
    pool_size: String.to_integer(System.get_env("POOL_SIZE") || "10")
end
```

DATABASE_URL format:
```
ecto://username:password@hostname:port/database_name
```

## Creating the Database

### Using Mix Tasks

```bash
# Create the database
$ mix ecto.create
The database for Snippetbox.Repo has been created

# Drop the database (if needed)
$ mix ecto.drop
The database for Snippetbox.Repo has been dropped

# Reset (drop + create + migrate)
$ mix ecto.reset
```

### Verify Connection

```bash
# Start IEx with your app
$ iex -S mix

# Test connection
iex> Snippetbox.Repo.query("SELECT 1")
{:ok, %Postgrex.Result{columns: ["?column?"], rows: [[1]]}}
```

## The Repo Module

Phoenix generates a Repo module that wraps Ecto:

```elixir
# File: lib/snippetbox/repo.ex

defmodule Snippetbox.Repo do
  use Ecto.Repo,
    otp_app: :snippetbox,
    adapter: Ecto.Adapters.Postgres
end
```

The Repo is started by your application supervisor:

```elixir
# File: lib/snippetbox/application.ex

def start(_type, _args) do
  children = [
    Snippetbox.Repo,  # Start database pool
    # ... other children
  ]

  Supervisor.start_link(children, strategy: :one_for_one)
end
```

## Common Database Tasks

### Check Connection Status

```elixir
# In IEx
iex> Snippetbox.Repo.checkout(fn -> :connected end)
:connected
```

### Run Raw SQL

```elixir
iex> Snippetbox.Repo.query("SELECT current_database()")
{:ok, %Postgrex.Result{columns: ["current_database"], rows: [["snippetbox_dev"]]}}

iex> Snippetbox.Repo.query("SELECT version()")
{:ok, %Postgrex.Result{columns: ["version"], rows: [["PostgreSQL 15.4..."]]}}
```

### Database Info

```bash
# List databases
$ psql -U postgres -c "\l"

# Connect to database
$ psql -U postgres -d snippetbox_dev

# List tables (after migrations)
snippetbox_dev=# \dt

# Describe table
snippetbox_dev=# \d snippets
```

## Troubleshooting

### Connection Refused

```
** (DBConnection.ConnectionError) tcp connect (localhost:5432): connection refused
```

Fix: Ensure PostgreSQL is running:
```bash
$ brew services start postgresql@15
# or
$ sudo systemctl start postgresql
```

### Authentication Failed

```
** (Postgrex.Error) FATAL 28P01 (invalid_password)
```

Fix: Check username/password in config or update pg_hba.conf.

### Database Does Not Exist

```
** (Postgrex.Error) FATAL 3D000 (invalid_catalog_name) database "snippetbox_dev" does not exist
```

Fix: Run `mix ecto.create`.

### Permission Denied

```
** (Postgrex.Error) FATAL 42501 (insufficient_privilege)
```

Fix: Grant privileges to user:
```sql
GRANT ALL PRIVILEGES ON DATABASE snippetbox_dev TO postgres;
```

> **FP Concept: Repo as a Boundary**
>
> The Repo module represents a system boundary - where your pure functional code meets the outside world (database):
>
> ```elixir
> # Pure function - transforms data
> def changeset(snippet, attrs) do
>   snippet
>   |> cast(attrs, [:title, :content])
>   |> validate_required([:title])
> end
>
> # Impure - interacts with database through Repo
> def create_snippet(attrs) do
>   %Snippet{}
>   |> changeset(attrs)
>   |> Repo.insert()
> end
> ```
>
> This separation keeps most of your code pure and testable, with database interactions isolated to specific points.
>
> **Further Reading**:
> - [Ecto.Repo](https://hexdocs.pm/ecto/Ecto.Repo.html)
> - [Functional Core, Imperative Shell](https://www.destroyallsoftware.com/screencasts/catalog/functional-core-imperative-shell)

## Summary

In this chapter, we learned:

- Installing PostgreSQL on different platforms
- Configuring Phoenix database connection
- Creating and managing databases with mix tasks
- Understanding the Repo module
- Troubleshooting common connection issues

In the next chapter, we'll create our first database migration.

---

## Additional Information

### Connection Pool Sizing

For development: 10 connections is fine.
For production, use this formula:

```
pool_size = (cores * 2) + effective_spindle_count
```

For most web apps: 10-20 connections per node.

### PostgreSQL Extensions

Enable useful extensions:

```elixir
# In a migration
def change do
  execute "CREATE EXTENSION IF NOT EXISTS citext"
  execute "CREATE EXTENSION IF NOT EXISTS pgcrypto"
  execute "CREATE EXTENSION IF NOT EXISTS pg_trgm"
end
```

### Multiple Databases

Phoenix supports multiple repos:

```elixir
# File: config/config.exs
config :snippetbox,
  ecto_repos: [Snippetbox.Repo, Snippetbox.AnalyticsRepo]

# File: lib/snippetbox/analytics_repo.ex
defmodule Snippetbox.AnalyticsRepo do
  use Ecto.Repo,
    otp_app: :snippetbox,
    adapter: Ecto.Adapters.Postgres
end
```
