# Chapter 7.3: Custom Routes

While `resources` generates standard CRUD routes, many applications need custom routes. In this chapter, we'll explore patterns for routes beyond REST conventions.

## Member and Collection Routes

### Adding to Resources

```elixir
# File: lib/snippetbox_web/router.ex

resources "/snippets", SnippetController do
  # Member routes - operate on a specific snippet
  post "/publish", SnippetController, :publish
  post "/archive", SnippetController, :archive
  get "/stats", SnippetController, :stats

  # Collection routes - operate on the collection
  get "/search", SnippetController, :search, as: :search
  get "/recent", SnippetController, :recent, as: :recent
end
```

Generated routes:
| Verb | Path | Action | Helper |
|------|------|--------|--------|
| POST | /snippets/:snippet_id/publish | :publish | `~p"/snippets/#{snippet}/publish"` |
| POST | /snippets/:snippet_id/archive | :archive | `~p"/snippets/#{snippet}/archive"` |
| GET | /snippets/:snippet_id/stats | :stats | `~p"/snippets/#{snippet}/stats"` |
| GET | /snippets/search | :search | `~p"/snippets/search"` |
| GET | /snippets/recent | :recent | `~p"/snippets/recent"` |

### Controller Implementation

```elixir
# File: lib/snippetbox_web/controllers/snippet_controller.ex

defmodule SnippetboxWeb.SnippetController do
  use SnippetboxWeb, :controller

  alias Snippetbox.Snippets

  # Standard CRUD actions...

  # Member action - operates on specific snippet
  def publish(conn, %{"snippet_id" => id}) do
    snippet = Snippets.get_snippet!(id)

    case Snippets.publish_snippet(snippet) do
      {:ok, snippet} ->
        conn
        |> put_flash(:info, "Snippet published!")
        |> redirect(to: ~p"/snippets/#{snippet}")

      {:error, _changeset} ->
        conn
        |> put_flash(:error, "Could not publish snippet.")
        |> redirect(to: ~p"/snippets/#{snippet}")
    end
  end

  def archive(conn, %{"snippet_id" => id}) do
    snippet = Snippets.get_snippet!(id)
    {:ok, snippet} = Snippets.archive_snippet(snippet)

    conn
    |> put_flash(:info, "Snippet archived.")
    |> redirect(to: ~p"/snippets")
  end

  def stats(conn, %{"snippet_id" => id}) do
    snippet = Snippets.get_snippet!(id)
    stats = Snippets.get_snippet_stats(snippet)
    render(conn, :stats, snippet: snippet, stats: stats)
  end

  # Collection actions
  def search(conn, %{"q" => query}) do
    snippets = Snippets.search_snippets(query)
    render(conn, :search, snippets: snippets, query: query)
  end

  def search(conn, _params) do
    render(conn, :search, snippets: [], query: "")
  end

  def recent(conn, _params) do
    snippets = Snippets.list_recent_snippets(limit: 20)
    render(conn, :recent, snippets: snippets)
  end
end
```

## Standalone Custom Routes

### Basic Custom Routes

```elixir
scope "/", SnippetboxWeb do
  pipe_through :browser

  # Static pages
  get "/about", PageController, :about
  get "/contact", PageController, :contact
  get "/privacy", PageController, :privacy
  get "/terms", PageController, :terms

  # Feature pages
  get "/explore", ExploreController, :index
  get "/trending", ExploreController, :trending
  get "/featured", ExploreController, :featured
end
```

### Dashboard Routes

```elixir
scope "/dashboard", SnippetboxWeb.Dashboard, as: :dashboard do
  pipe_through [:browser, :require_authenticated_user]

  get "/", DashboardController, :index
  get "/activity", DashboardController, :activity
  get "/analytics", DashboardController, :analytics

  # Settings subsection
  get "/settings", SettingsController, :index
  get "/settings/profile", SettingsController, :profile
  put "/settings/profile", SettingsController, :update_profile
  get "/settings/security", SettingsController, :security
  put "/settings/security", SettingsController, :update_security
  get "/settings/notifications", SettingsController, :notifications
  put "/settings/notifications", SettingsController, :update_notifications
end
```

## Route Constraints

### Parameter Constraints

```elixir
# Only match numeric IDs
get "/snippets/:id", SnippetController, :show when is_integer(id)

# Using constraints option
get "/users/:username", UserController, :show, constraints: %{username: ~r/^[a-z0-9_]+$/}

# ID format constraint
get "/snippets/:id", SnippetController, :show, constraints: %{id: ~r/^\d+$/}
```

### Custom Matchers

```elixir
# File: lib/snippetbox_web/router.ex

defmodule SnippetboxWeb.Router do
  use SnippetboxWeb, :router

  # Match UUID format
  @uuid_regex ~r/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i

  scope "/", SnippetboxWeb do
    pipe_through :browser

    get "/snippets/:id", SnippetController, :show, constraints: %{id: @uuid_regex}
  end
end
```

## Catch-All Routes

### 404 Handler

```elixir
scope "/", SnippetboxWeb do
  pipe_through :browser

  # Define specific routes first
  get "/", PageController, :home
  resources "/snippets", SnippetController

  # Catch-all must be last
  get "/*path", PageController, :not_found
end
```

```elixir
# File: lib/snippetbox_web/controllers/page_controller.ex

def not_found(conn, _params) do
  conn
  |> put_status(:not_found)
  |> put_view(SnippetboxWeb.ErrorHTML)
  |> render("404.html")
end
```

### Slug-Based Routes

```elixir
scope "/", SnippetboxWeb do
  pipe_through :browser

  # Specific routes first
  get "/", PageController, :home
  get "/about", PageController, :about
  resources "/snippets", SnippetController

  # User profile by username (catch-all pattern)
  get "/:username", ProfileController, :show
end
```

## Redirect Routes

### Simple Redirects

```elixir
scope "/", SnippetboxWeb do
  pipe_through :browser

  # Redirect old URLs to new ones
  get "/old-path", Redirect, to: "/new-path"
  get "/legacy/snippets", Redirect, to: "/snippets"
end
```

Create a redirect plug:

```elixir
# File: lib/snippetbox_web/plugs/redirect.ex

defmodule SnippetboxWeb.Redirect do
  @behaviour Plug

  def init(opts), do: opts

  def call(conn, opts) do
    conn
    |> Phoenix.Controller.redirect(to: opts[:to])
    |> Plug.Conn.halt()
  end
end
```

### Dynamic Redirects

```elixir
# File: lib/snippetbox_web/controllers/redirect_controller.ex

defmodule SnippetboxWeb.RedirectController do
  use SnippetboxWeb, :controller

  # Redirect old snippet URLs
  def old_snippet(conn, %{"id" => id}) do
    redirect(conn, to: ~p"/snippets/#{id}")
  end

  # Redirect with external URL
  def github(conn, _params) do
    redirect(conn, external: "https://github.com/snippetbox")
  end
end
```

```elixir
# In router
get "/s/:id", RedirectController, :old_snippet
get "/github", RedirectController, :github
```

## RESTful Actions Beyond CRUD

### Bulk Operations

```elixir
scope "/", SnippetboxWeb do
  pipe_through [:browser, :require_authenticated_user]

  # Bulk actions on snippets
  post "/snippets/bulk/delete", SnippetController, :bulk_delete
  post "/snippets/bulk/archive", SnippetController, :bulk_archive
  post "/snippets/bulk/publish", SnippetController, :bulk_publish
end
```

```elixir
def bulk_delete(conn, %{"ids" => ids}) do
  user = conn.assigns.current_user
  {deleted_count, _} = Snippets.delete_user_snippets(user, ids)

  conn
  |> put_flash(:info, "Deleted #{deleted_count} snippets.")
  |> redirect(to: ~p"/snippets")
end
```

### State Transitions

```elixir
resources "/orders", OrderController do
  # State machine transitions
  post "/confirm", OrderController, :confirm
  post "/ship", OrderController, :ship
  post "/deliver", OrderController, :deliver
  post "/cancel", OrderController, :cancel
  post "/refund", OrderController, :refund
end
```

## API-Style Routes

### JSON Endpoints

```elixir
scope "/api", SnippetboxWeb.API, as: :api do
  pipe_through :api

  # Search
  get "/search", SearchController, :index

  # Autocomplete
  get "/autocomplete/users", AutocompleteController, :users
  get "/autocomplete/tags", AutocompleteController, :tags

  # Stats
  get "/stats/snippets", StatsController, :snippets
  get "/stats/users", StatsController, :users

  # Webhooks
  post "/webhooks/github", WebhookController, :github
  post "/webhooks/stripe", WebhookController, :stripe
end
```

### Mixed HTML/JSON Routes

```elixir
scope "/snippets", SnippetboxWeb do
  pipe_through :browser

  resources "/", SnippetController
end

scope "/snippets", SnippetboxWeb.API do
  pipe_through :api

  # JSON versions of same resources
  get "/", SnippetController, :index
  get "/:id", SnippetController, :show
  post "/", SnippetController, :create
  put "/:id", SnippetController, :update
  delete "/:id", SnippetController, :delete
end
```

## Route Helpers and Verified Routes

### Using Verified Routes

```elixir
# In controllers and templates
~p"/snippets"
~p"/snippets/#{@snippet}"
~p"/snippets/#{@snippet}/edit"
~p"/snippets/#{@snippet}/publish"

# With query params
~p"/snippets?#{[page: 2, per_page: 20]}"
~p"/snippets/search?#{[q: @query]}"
```

### In Templates

```heex
<.link href={~p"/snippets/#{@snippet}/publish"} method="post">
  Publish
</.link>

<.link href={~p"/snippets/#{@snippet}/archive"} method="post" data-confirm="Are you sure?">
  Archive
</.link>

<form action={~p"/snippets/search"} method="get">
  <input type="text" name="q" value={@query} placeholder="Search...">
  <button type="submit">Search</button>
</form>
```

## Organizing Complex Routes

### Route Modules

```elixir
# File: lib/snippetbox_web/router.ex

defmodule SnippetboxWeb.Router do
  use SnippetboxWeb, :router

  import SnippetboxWeb.Router.{
    BrowserRoutes,
    APIRoutes,
    AdminRoutes
  }

  pipeline :browser do
    # ...
  end

  pipeline :api do
    # ...
  end

  browser_routes()
  api_routes()
  admin_routes()
end
```

```elixir
# File: lib/snippetbox_web/router/browser_routes.ex

defmodule SnippetboxWeb.Router.BrowserRoutes do
  defmacro browser_routes do
    quote do
      scope "/", SnippetboxWeb do
        pipe_through :browser

        get "/", PageController, :home
        resources "/snippets", SnippetController
        # ... more routes
      end
    end
  end
end
```

### Documentation

```elixir
# File: lib/snippetbox_web/router.ex

defmodule SnippetboxWeb.Router do
  @moduledoc """
  Router for SnippetboxWeb application.

  ## Route Groups

  - `/` - Public pages (home, about, etc.)
  - `/snippets` - Snippet CRUD and actions
  - `/users` - User profiles
  - `/dashboard` - Authenticated user dashboard
  - `/admin` - Admin panel (requires admin role)
  - `/api` - JSON API endpoints
  """

  use SnippetboxWeb, :router

  # Routes...
end
```

> **FP Concept: Declarative Routing**
>
> Phoenix routes are declarative - you describe *what* you want, not *how* to achieve it:
>
> ```elixir
> # Declarative: "This path maps to this action"
> get "/snippets/:id", SnippetController, :show
>
> # The router handles:
> # - Pattern matching the URL
> # - Extracting parameters
> # - Calling the right function
> # - Handling errors
> ```
>
> This mirrors functional programming's preference for declaring transformations rather than writing imperative step-by-step instructions.
>
> **Further Reading**:
> - [Phoenix Routing Guide](https://hexdocs.pm/phoenix/routing.html)

## Summary

In this chapter, we learned:

- Adding member and collection routes to resources
- Creating standalone custom routes
- Using route constraints for validation
- Implementing catch-all and redirect routes
- Building API-style endpoints
- Organizing complex route configurations
- Using verified routes in controllers and templates

This completes the Advanced Routing chapter. In the next chapter, we'll explore processing forms in Phoenix.
