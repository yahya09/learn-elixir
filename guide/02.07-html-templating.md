# Chapter 2.7: HTML Templating with EEx

Phoenix uses EEx (Embedded Elixir) for templating. In this chapter, we'll learn how to create dynamic HTML pages using Phoenix's powerful templating system.

## Understanding EEx

EEx is Elixir's templating engine. It allows you to embed Elixir code within HTML:

```heex
<h1>Welcome, <%= @user.name %>!</h1>
```

Phoenix extends EEx with HEEx (HTML-aware EEx) which provides:
- Compile-time validation of HTML
- Component support
- Better error messages
- XSS protection by default

## Template File Conventions

Phoenix templates use the `.heex` extension and live alongside their view modules:

```
lib/snippetbox_web/controllers/
├── snippet_controller.ex      # Controller
├── snippet_html.ex            # View module
└── snippet_html/              # Templates directory
    ├── index.html.heex        # Index template
    ├── show.html.heex         # Show template
    ├── new.html.heex          # New template
    └── edit.html.heex         # Edit template
```

## Creating Your First Template

Let's create a template for displaying snippets.

### Step 1: The Controller

```elixir
# File: lib/snippetbox_web/controllers/snippet_controller.ex

defmodule SnippetboxWeb.SnippetController do
  use SnippetboxWeb, :controller

  def show(conn, %{"id" => id}) do
    snippet = %{
      id: id,
      title: "Example Snippet",
      content: "puts 'Hello, World!'",
      created_at: ~N[2024-01-15 10:30:00]
    }

    render(conn, :show, snippet: snippet)
  end
end
```

### Step 2: The View Module

```elixir
# File: lib/snippetbox_web/controllers/snippet_html.ex

defmodule SnippetboxWeb.SnippetHTML do
  use SnippetboxWeb, :html

  embed_templates "snippet_html/*"
end
```

The `embed_templates` macro automatically loads all `.heex` files from the specified directory.

### Step 3: The Template

```heex
<%# File: lib/snippetbox_web/controllers/snippet_html/show.html.heex %>

<div class="snippet">
  <h1><%= @snippet.title %></h1>

  <div class="metadata">
    <span>ID: <%= @snippet.id %></span>
    <span>Created: <%= @snippet.created_at %></span>
  </div>

  <pre class="content"><code><%= @snippet.content %></code></pre>
</div>
```

## EEx Syntax

### Output Tags

Use `<%= %>` to output expressions (escaped by default):

```heex
<%# Output escaped HTML (safe) %>
<p><%= @user.bio %></p>

<%# If @user.bio contains "<script>", it becomes "&lt;script&gt;" %>
```

### Raw Output

Use `raw/1` when you trust the content (dangerous - use carefully):

```heex
<%# Output unescaped HTML (dangerous!) %>
<div><%= raw(@snippet.html_content) %></div>
```

### Code Tags

Use `<% %>` for code that doesn't output:

```heex
<% formatted_date = Calendar.strftime(@snippet.created_at, "%B %d, %Y") %>
<p>Created on <%= formatted_date %></p>
```

### Comments

```heex
<%# This is a comment - not rendered in output %>

<!-- This is an HTML comment - rendered in output -->
```

## Control Flow in Templates

### Conditionals

```heex
<%= if @snippet.published do %>
  <span class="badge">Published</span>
<% else %>
  <span class="badge draft">Draft</span>
<% end %>
```

Using `case`:

```heex
<%= case @snippet.status do %>
  <% :published -> %>
    <span class="badge published">Published</span>
  <% :draft -> %>
    <span class="badge draft">Draft</span>
  <% :archived -> %>
    <span class="badge archived">Archived</span>
<% end %>
```

Using `cond`:

```heex
<%= cond do %>
  <% @snippet.views > 1000 -> %>
    <span class="popular">Popular!</span>
  <% @snippet.views > 100 -> %>
    <span class="trending">Trending</span>
  <% true -> %>
    <span class="new">New</span>
<% end %>
```

### Loops

Iterate with `for`:

```heex
<ul class="snippets">
  <%= for snippet <- @snippets do %>
    <li>
      <a href={~p"/snippets/#{snippet.id}"}>
        <%= snippet.title %>
      </a>
    </li>
  <% end %>
</ul>
```

With index:

```heex
<ol>
  <%= for {snippet, index} <- Enum.with_index(@snippets) do %>
    <li>
      <span class="number"><%= index + 1 %>.</span>
      <%= snippet.title %>
    </li>
  <% end %>
</ol>
```

Filtering in loops:

```heex
<%= for snippet <- @snippets, snippet.published do %>
  <div class="snippet"><%= snippet.title %></div>
<% end %>
```

## Assigns and the @ Sigil

Variables passed to templates are called **assigns**. Access them with `@`:

```elixir
# Controller
render(conn, :show,
  snippet: snippet,
  user: current_user,
  can_edit: true
)
```

```heex
<%# Template %>
<h1><%= @snippet.title %></h1>
<p>By <%= @user.name %></p>

<%= if @can_edit do %>
  <a href={~p"/snippets/#{@snippet.id}/edit"}>Edit</a>
<% end %>
```

### Checking if Assign Exists

```heex
<%= if assigns[:flash_message] do %>
  <div class="flash"><%= @flash_message %></div>
<% end %>
```

Or use `Map.get/3`:

```heex
<%= Map.get(assigns, :page_title, "Default Title") %>
```

## Layouts

Phoenix uses layouts to wrap your templates with common HTML structure.

### Root Layout

The root layout contains the HTML skeleton:

```heex
<%# File: lib/snippetbox_web/components/layouts/root.html.heex %>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="csrf-token" content={get_csrf_token()} />
    <title><%= assigns[:page_title] || "Snippetbox" %></title>
    <link phx-track-static rel="stylesheet" href={~p"/assets/app.css"} />
    <script defer phx-track-static src={~p"/assets/app.js"}></script>
  </head>
  <body>
    <%= @inner_content %>
  </body>
</html>
```

### App Layout

The app layout wraps page content with navigation:

```heex
<%# File: lib/snippetbox_web/components/layouts/app.html.heex %>

<header>
  <nav>
    <a href={~p"/"}>Home</a>
    <a href={~p"/snippets"}>Snippets</a>
    <a href={~p"/about"}>About</a>
  </nav>
</header>

<main class="container">
  <.flash_group flash={@flash} />
  <%= @inner_content %>
</main>

<footer>
  <p>&copy; <%= DateTime.utc_now().year %> Snippetbox</p>
</footer>
```

### Changing Layouts

Change layout for specific actions:

```elixir
def login(conn, _params) do
  conn
  |> put_layout(html: :auth)  # Use auth.html.heex layout
  |> render(:login)
end

def api_docs(conn, _params) do
  conn
  |> put_layout(false)  # No layout
  |> render(:api_docs)
end
```

### Setting Page Titles

```elixir
# In controller
def show(conn, %{"id" => id}) do
  snippet = get_snippet(id)

  conn
  |> assign(:page_title, snippet.title)
  |> render(:show, snippet: snippet)
end
```

## Helper Functions in Views

Add helper functions to your view module:

```elixir
# File: lib/snippetbox_web/controllers/snippet_html.ex

defmodule SnippetboxWeb.SnippetHTML do
  use SnippetboxWeb, :html

  embed_templates "snippet_html/*"

  def format_date(datetime) do
    Calendar.strftime(datetime, "%B %d, %Y at %H:%M")
  end

  def truncate(text, max_length \\ 100) do
    if String.length(text) > max_length do
      String.slice(text, 0, max_length) <> "..."
    else
      text
    end
  end

  def snippet_class(snippet) do
    cond do
      snippet.expired -> "snippet expired"
      snippet.featured -> "snippet featured"
      true -> "snippet"
    end
  end
end
```

Use in templates:

```heex
<div class={snippet_class(@snippet)}>
  <h2><%= @snippet.title %></h2>
  <p><%= truncate(@snippet.content, 200) %></p>
  <time><%= format_date(@snippet.created_at) %></time>
</div>
```

## Verified Routes

Phoenix provides compile-time verified routes with `~p`:

```heex
<%# These are checked at compile time %>
<a href={~p"/"}>Home</a>
<a href={~p"/snippets"}>All Snippets</a>
<a href={~p"/snippets/#{@snippet.id}"}>View Snippet</a>
<a href={~p"/snippets/#{@snippet}/edit"}>Edit</a>

<%# With query parameters %>
<a href={~p"/snippets?#{[page: 2, sort: "date"]}"}>Page 2</a>
```

If you reference a route that doesn't exist, you'll get a compile error.

## Partials and Rendering

### Rendering Other Templates

```heex
<%# Render another template %>
<%= render("_sidebar.html", assigns) %>

<%# With specific assigns %>
<%= render("_snippet_card.html", snippet: @snippet, show_author: true) %>
```

### Creating Partials

By convention, partials start with underscore:

```heex
<%# File: lib/snippetbox_web/controllers/snippet_html/_snippet_card.html.heex %>

<div class="snippet-card">
  <h3><%= @snippet.title %></h3>
  <p><%= truncate(@snippet.content) %></p>
  <%= if @show_author do %>
    <span class="author">By <%= @snippet.author.name %></span>
  <% end %>
</div>
```

### Rendering Lists

```heex
<%= for snippet <- @snippets do %>
  <%= render("_snippet_card.html", snippet: snippet, show_author: true) %>
<% end %>
```

## Common Template Patterns

### Empty State

```heex
<%= if Enum.empty?(@snippets) do %>
  <div class="empty-state">
    <p>No snippets yet.</p>
    <a href={~p"/snippets/new"} class="btn">Create your first snippet</a>
  </div>
<% else %>
  <div class="snippets-list">
    <%= for snippet <- @snippets do %>
      <div class="snippet"><%= snippet.title %></div>
    <% end %>
  </div>
<% end %>
```

### Loading States

```heex
<div id="snippets" class={if @loading, do: "loading"}>
  <%= if @loading do %>
    <div class="spinner">Loading...</div>
  <% else %>
    <%= for snippet <- @snippets do %>
      <div class="snippet"><%= snippet.title %></div>
    <% end %>
  <% end %>
</div>
```

### Conditional Classes

```heex
<div class={[
  "snippet",
  @snippet.featured && "featured",
  @snippet.expired && "expired"
]}>
  <%= @snippet.title %>
</div>
```

Phoenix automatically filters out `false` and `nil` values from class lists.

> **FP Concept: Expression-Based Templates**
>
> In HEEx, everything is an expression that returns a value:
>
> ```heex
> <%# This is an expression that returns a string %>
> <%= if @count > 0, do: "#{@count} items", else: "No items" %>
> ```
>
> Unlike imperative templates that execute statements, functional templates compose expressions. Each `<%= %>` block returns a value that becomes part of the output.
>
> Benefits:
> - No side effects in templates
> - Easier to reason about output
> - Better testability
> - Compile-time optimization
>
> **Further Reading**:
> - [HEEx Documentation](https://hexdocs.pm/phoenix_live_view/Phoenix.Component.html#module-heex)
> - [EEx Documentation](https://hexdocs.pm/eex/EEx.html)

## Summary

In this chapter, we learned:

- EEx syntax for embedding Elixir in HTML
- How templates connect to controllers and views
- Control flow with conditionals and loops
- Working with assigns and layouts
- Creating helper functions and partials
- Verified routes with `~p` sigil

In the next chapter, we'll learn how to serve static files like CSS, JavaScript, and images.

---

## Additional Information

### HEEx vs EEx

Phoenix 1.7+ uses HEEx by default:

| Feature | EEx | HEEx |
|---------|-----|------|
| Extension | `.eex` | `.heex` |
| HTML validation | No | Yes |
| Components | No | Yes |
| Compile-time checks | Basic | Comprehensive |
| XSS protection | Manual | Automatic |

### Comparing to Other Frameworks

**ERB (Ruby/Rails)**:
```erb
<% @snippets.each do |snippet| %>
  <div><%= snippet.title %></div>
<% end %>
```

**Jinja2 (Python/Flask)**:
```jinja
{% for snippet in snippets %}
  <div>{{ snippet.title }}</div>
{% endfor %}
```

**Blade (PHP/Laravel)**:
```blade
@foreach ($snippets as $snippet)
  <div>{{ $snippet->title }}</div>
@endforeach
```

**HEEx (Elixir/Phoenix)**:
```heex
<%= for snippet <- @snippets do %>
  <div><%= snippet.title %></div>
<% end %>
```

Phoenix's HEEx is closest to ERB but with Elixir's pattern matching and functional approach.
