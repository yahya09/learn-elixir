# Chapter 7.2: Scopes and Namespaces

Scopes and namespaces help organize routes logically. In this chapter, we'll explore different ways to group and structure routes.

## Understanding Scopes

A scope groups routes under a common path prefix:

```elixir
# File: lib/snippetbox_web/router.ex

scope "/api", SnippetboxWeb do
  pipe_through :api

  resources "/snippets", API.SnippetController
  resources "/users", API.UserController
end
```

Generated routes:
- `GET /api/snippets` → `API.SnippetController :index`
- `GET /api/users` → `API.UserController :index`

## Scope Options

### Path Prefix

```elixir
# Add path prefix
scope "/admin", SnippetboxWeb.Admin do
  pipe_through [:browser, :require_admin]

  resources "/users", UserController
  resources "/snippets", SnippetController
end
```

### Module Namespace

```elixir
# Set module namespace
scope "/admin", SnippetboxWeb.Admin, as: :admin do
  pipe_through [:browser, :require_admin]

  resources "/users", UserController
  resources "/snippets", SnippetController
end
```

This creates:
- Controllers in `SnippetboxWeb.Admin` namespace
- Route helpers with `admin_` prefix
- Paths prefixed with `/admin`

### Alias Option

```elixir
# Custom alias for route helpers
scope "/management", SnippetboxWeb.Admin, as: :mgmt do
  resources "/users", UserController
end

# Route helper: ~p"/management/users" or mgmt_user_path
```

## Multiple Scopes

### API Versioning

```elixir
scope "/api", SnippetboxWeb.API do
  pipe_through :api

  scope "/v1", V1, as: :v1 do
    resources "/snippets", SnippetController
    resources "/users", UserController
  end

  scope "/v2", V2, as: :v2 do
    resources "/snippets", SnippetController
    resources "/users", UserController
    resources "/tags", TagController  # New in v2
  end
end
```

Generated routes:
- `GET /api/v1/snippets` → `SnippetboxWeb.API.V1.SnippetController`
- `GET /api/v2/snippets` → `SnippetboxWeb.API.V2.SnippetController`

### Admin Section

```elixir
# Public routes
scope "/", SnippetboxWeb do
  pipe_through :browser

  get "/", PageController, :home
  resources "/snippets", SnippetController, only: [:index, :show]
end

# Authenticated user routes
scope "/", SnippetboxWeb do
  pipe_through [:browser, :require_authenticated_user]

  resources "/snippets", SnippetController, only: [:new, :create, :edit, :update, :delete]
  get "/account", AccountController, :show
end

# Admin routes
scope "/admin", SnippetboxWeb.Admin, as: :admin do
  pipe_through [:browser, :require_admin]

  get "/dashboard", DashboardController, :index
  resources "/users", UserController
  resources "/snippets", SnippetController
end
```

## Namespaces with Controllers

### Directory Structure

```
lib/snippetbox_web/controllers/
├── page_controller.ex
├── snippet_controller.ex
├── api/
│   ├── v1/
│   │   ├── snippet_controller.ex
│   │   └── user_controller.ex
│   └── v2/
│       ├── snippet_controller.ex
│       └── user_controller.ex
└── admin/
    ├── dashboard_controller.ex
    ├── user_controller.ex
    └── snippet_controller.ex
```

### Namespaced Controller

```elixir
# File: lib/snippetbox_web/controllers/admin/user_controller.ex

defmodule SnippetboxWeb.Admin.UserController do
  use SnippetboxWeb, :controller

  alias Snippetbox.Accounts

  def index(conn, _params) do
    users = Accounts.list_users()
    render(conn, :index, users: users)
  end

  def show(conn, %{"id" => id}) do
    user = Accounts.get_user!(id)
    render(conn, :show, user: user)
  end

  def delete(conn, %{"id" => id}) do
    user = Accounts.get_user!(id)
    {:ok, _} = Accounts.delete_user(user)

    conn
    |> put_flash(:info, "User deleted successfully.")
    |> redirect(to: ~p"/admin/users")
  end
end
```

### Namespaced Views and Templates

```elixir
# File: lib/snippetbox_web/controllers/admin/user_html.ex

defmodule SnippetboxWeb.Admin.UserHTML do
  use SnippetboxWeb, :html

  embed_templates "user_html/*"
end
```

Templates go in:
```
lib/snippetbox_web/controllers/admin/user_html/
├── index.html.heex
├── show.html.heex
└── edit.html.heex
```

## Scope Without Path

Use `scope` without a path to group routes with same pipeline:

```elixir
# No path prefix, just grouping by pipeline
scope "/", SnippetboxWeb do
  pipe_through [:browser, :require_authenticated_user]

  # All these require authentication
  resources "/snippets", SnippetController, except: [:index, :show]
  get "/settings", SettingsController, :edit
  put "/settings", SettingsController, :update
end
```

## Host-Based Scopes

Route based on hostname:

```elixir
scope "/", SnippetboxWeb, host: "api." do
  pipe_through :api
  resources "/snippets", API.SnippetController
end

scope "/", SnippetboxWeb, host: "admin." do
  pipe_through [:browser, :require_admin]
  resources "/users", Admin.UserController
end

scope "/", SnippetboxWeb do
  pipe_through :browser
  get "/", PageController, :home
end
```

Routes:
- `api.example.com/snippets` → API.SnippetController
- `admin.example.com/users` → Admin.UserController
- `example.com/` → PageController

## Forward to Another Router

Split large routers into modules:

```elixir
# File: lib/snippetbox_web/router.ex

defmodule SnippetboxWeb.Router do
  use SnippetboxWeb, :router

  # Main routes
  scope "/", SnippetboxWeb do
    pipe_through :browser
    get "/", PageController, :home
  end

  # Forward to API router
  forward "/api", SnippetboxWeb.API.Router

  # Forward to Admin router
  forward "/admin", SnippetboxWeb.Admin.Router
end
```

```elixir
# File: lib/snippetbox_web/api/router.ex

defmodule SnippetboxWeb.API.Router do
  use SnippetboxWeb, :router

  pipeline :api do
    plug :accepts, ["json"]
  end

  scope "/v1", SnippetboxWeb.API.V1, as: :v1 do
    pipe_through :api
    resources "/snippets", SnippetController
  end
end
```

## Combining Scopes and Pipelines

```elixir
defmodule SnippetboxWeb.Router do
  use SnippetboxWeb, :router

  pipeline :browser do
    plug :accepts, ["html"]
    plug :fetch_session
    plug :fetch_live_flash
    plug :put_root_layout, html: {SnippetboxWeb.Layouts, :root}
    plug :protect_from_forgery
    plug :put_secure_browser_headers
    plug :fetch_current_user
  end

  pipeline :api do
    plug :accepts, ["json"]
    plug :fetch_api_user
  end

  pipeline :require_authenticated_user do
    plug :require_authenticated_user
  end

  pipeline :require_admin do
    plug :require_role, :admin
  end

  # Public browser routes
  scope "/", SnippetboxWeb do
    pipe_through :browser

    get "/", PageController, :home
    resources "/snippets", SnippetController, only: [:index, :show]

    get "/login", SessionController, :new
    post "/login", SessionController, :create
    get "/register", UserController, :new
    post "/register", UserController, :create
  end

  # Authenticated browser routes
  scope "/", SnippetboxWeb do
    pipe_through [:browser, :require_authenticated_user]

    delete "/logout", SessionController, :delete
    resources "/snippets", SnippetController, only: [:new, :create, :edit, :update, :delete]

    scope "/account", as: :account do
      get "/", AccountController, :show
      get "/edit", AccountController, :edit
      put "/", AccountController, :update
      get "/password", AccountController, :edit_password
      put "/password", AccountController, :update_password
    end
  end

  # Admin routes
  scope "/admin", SnippetboxWeb.Admin, as: :admin do
    pipe_through [:browser, :require_authenticated_user, :require_admin]

    get "/", DashboardController, :index
    resources "/users", UserController
    resources "/snippets", SnippetController
  end

  # API routes
  scope "/api", SnippetboxWeb.API, as: :api do
    pipe_through :api

    scope "/v1", V1, as: :v1 do
      resources "/snippets", SnippetController, except: [:new, :edit]
      resources "/users", UserController, only: [:show]
    end
  end
end
```

## Verified Routes with Scopes

```elixir
# Standard routes
~p"/snippets"
~p"/snippets/#{snippet}"

# Admin routes (with :admin alias)
~p"/admin/users"
~p"/admin/users/#{user}"

# API routes
~p"/api/v1/snippets"

# In templates
<.link href={~p"/admin/users/#{@user}"}>
  Edit User
</.link>
```

> **FP Concept: Modular Composition**
>
> Scopes and namespaces enable modular route composition:
>
> ```elixir
> # Each scope is independent and composable
> scope "/api" do
>   scope "/v1" do ... end
>   scope "/v2" do ... end
> end
> ```
>
> This mirrors functional design where small, focused modules compose into larger systems. Each scope is self-contained and can be tested independently.
>
> **Further Reading**:
> - [Phoenix Routing](https://hexdocs.pm/phoenix/routing.html)
> - [Phoenix Scopes](https://hexdocs.pm/phoenix/routing.html#scoped-routes)

## Summary

In this chapter, we learned:

- Creating scopes with path prefixes
- Setting module namespaces
- API versioning with scopes
- Organizing controllers and templates by namespace
- Host-based routing
- Forwarding to other routers
- Combining scopes with pipelines

In the next chapter, we'll explore custom routes beyond REST conventions.
