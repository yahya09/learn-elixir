# Chapter 5.1: Displaying Data

In this chapter, we'll connect our database to our templates, displaying snippets dynamically on our pages.

## The Complete Flow

```
1. Request arrives at router
2. Router dispatches to controller
3. Controller queries database via context
4. Controller passes data to template
5. Template renders HTML with data
6. Response sent to browser
```

## Setting Up the Controller

```elixir
# File: lib/snippetbox_web/controllers/snippet_controller.ex

defmodule SnippetboxWeb.SnippetController do
  use SnippetboxWeb, :controller

  alias Snippetbox.Snippets

  def index(conn, _params) do
    snippets = Snippets.list_public_snippets()
    render(conn, :index, snippets: snippets)
  end

  def show(conn, %{"id" => id}) do
    snippet = Snippets.get_snippet!(id)
    render(conn, :show, snippet: snippet)
  end
end
```

## The Context Layer

```elixir
# File: lib/snippetbox/snippets.ex

defmodule Snippetbox.Snippets do
  import Ecto.Query
  alias Snippetbox.Repo
  alias Snippetbox.Snippets.Snippet

  def list_public_snippets do
    Snippet
    |> where([s], s.is_public == true)
    |> where([s], is_nil(s.expires_at) or s.expires_at > ^DateTime.utc_now())
    |> order_by([s], desc: s.inserted_at)
    |> Repo.all()
  end

  def get_snippet!(id) do
    Repo.get!(Snippet, id)
  end
end
```

## The View Module

```elixir
# File: lib/snippetbox_web/controllers/snippet_html.ex

defmodule SnippetboxWeb.SnippetHTML do
  use SnippetboxWeb, :html

  embed_templates "snippet_html/*"

  def format_date(datetime) do
    Calendar.strftime(datetime, "%B %d, %Y at %H:%M")
  end

  def time_ago(datetime) do
    diff = DateTime.diff(DateTime.utc_now(), datetime, :second)

    cond do
      diff < 60 -> "just now"
      diff < 3600 -> "#{div(diff, 60)} minutes ago"
      diff < 86400 -> "#{div(diff, 3600)} hours ago"
      diff < 604800 -> "#{div(diff, 86400)} days ago"
      true -> format_date(datetime)
    end
  end
end
```

## Displaying a Single Record

### Show Template

```heex
<%# File: lib/snippetbox_web/controllers/snippet_html/show.html.heex %>

<article class="snippet">
  <header class="snippet-header">
    <h1><%= @snippet.title %></h1>
    <div class="snippet-meta">
      <span class="language"><%= @snippet.language %></span>
      <span class="date">Created <%= time_ago(@snippet.inserted_at) %></span>
      <%= if @snippet.expires_at do %>
        <span class="expires">Expires <%= format_date(@snippet.expires_at) %></span>
      <% end %>
    </div>
  </header>

  <div class="snippet-content">
    <pre><code class={@snippet.language}><%= @snippet.content %></code></pre>
  </div>

  <footer class="snippet-footer">
    <span class="views"><%= @snippet.views_count %> views</span>
    <div class="actions">
      <a href={~p"/snippets/#{@snippet}/edit"} class="btn btn-secondary">Edit</a>
      <button class="btn btn-copy" data-content={@snippet.content}>Copy</button>
    </div>
  </footer>
</article>
```

## Understanding Assigns

Data passed from controller to template becomes **assigns**:

```elixir
# Controller
render(conn, :show, snippet: snippet, user: current_user, can_edit: true)

# Template - access with @
<%= @snippet.title %>
<%= @user.name %>
<%= if @can_edit, do: "Edit button" %>
```

### Checking for Assigns

```heex
<%# Safe access - returns nil if not set %>
<%= assigns[:optional_value] %>

<%# With default %>
<%= assigns[:page_title] || "Snippetbox" %>

<%# Check if set %>
<%= if assigns[:flash_message] do %>
  <div class="flash"><%= @flash_message %></div>
<% end %>
```

## Displaying Collections

### Index Template

```heex
<%# File: lib/snippetbox_web/controllers/snippet_html/index.html.heex %>

<div class="page-header">
  <h1>Latest Snippets</h1>
  <a href={~p"/snippets/new"} class="btn btn-primary">New Snippet</a>
</div>

<%= if Enum.empty?(@snippets) do %>
  <div class="empty-state">
    <p>No snippets yet.</p>
    <a href={~p"/snippets/new"}>Create your first snippet</a>
  </div>
<% else %>
  <div class="snippets-list">
    <%= for snippet <- @snippets do %>
      <article class="snippet-card">
        <h2>
          <a href={~p"/snippets/#{snippet}"}><%= snippet.title %></a>
        </h2>
        <div class="meta">
          <span class="language"><%= snippet.language %></span>
          <span class="date"><%= time_ago(snippet.inserted_at) %></span>
        </div>
        <p class="preview"><%= truncate(snippet.content, 100) %></p>
      </article>
    <% end %>
  </div>
<% end %>
```

### Adding the Truncate Helper

```elixir
# File: lib/snippetbox_web/controllers/snippet_html.ex

def truncate(text, max_length \\ 100) do
  if String.length(text) > max_length do
    text
    |> String.slice(0, max_length)
    |> String.trim_trailing()
    |> Kernel.<>("...")
  else
    text
  end
end
```

## Displaying Associated Data

When you need related data, preload it in the controller:

```elixir
# Controller
def show(conn, %{"id" => id}) do
  snippet = Snippets.get_snippet_with_user!(id)
  render(conn, :show, snippet: snippet)
end

# Context
def get_snippet_with_user!(id) do
  Snippet
  |> Repo.get!(id)
  |> Repo.preload(:user)
end
```

```heex
<%# Template %>
<article class="snippet">
  <h1><%= @snippet.title %></h1>
  <p class="author">
    By <%= @snippet.user.name %>
  </p>
</article>
```

## Handling Missing Data

### Nil Checks

```heex
<%# Safe navigation %>
<%= if @snippet.user do %>
  <span>By <%= @snippet.user.name %></span>
<% else %>
  <span>Anonymous</span>
<% end %>

<%# Or with case %>
<%= case @snippet.user do %>
  <% nil -> %>
    <span>Anonymous</span>
  <% user -> %>
    <span>By <%= user.name %></span>
<% end %>
```

### Default Values

```heex
<%= @snippet.language || "plain text" %>
<%= @snippet.views_count || 0 %>
```

## Displaying Different Data Types

### Dates and Times

```heex
<%# Full datetime %>
<time datetime={DateTime.to_iso8601(@snippet.inserted_at)}>
  <%= Calendar.strftime(@snippet.inserted_at, "%B %d, %Y at %I:%M %p") %>
</time>

<%# Just date %>
<%= Calendar.strftime(@snippet.inserted_at, "%Y-%m-%d") %>

<%# Relative time %>
<span title={DateTime.to_iso8601(@snippet.inserted_at)}>
  <%= time_ago(@snippet.inserted_at) %>
</span>
```

### Numbers

```heex
<%# With formatting %>
<%= Number.Delimited.number_to_delimited(@snippet.views_count) %>
<%# Output: 1,234,567 %>

<%# Or simple helper %>
<%= format_number(@snippet.views_count) %>
```

```elixir
# Helper
def format_number(n) when n >= 1_000_000, do: "#{Float.round(n / 1_000_000, 1)}M"
def format_number(n) when n >= 1_000, do: "#{Float.round(n / 1_000, 1)}K"
def format_number(n), do: to_string(n)
```

### Booleans

```heex
<%= if @snippet.is_public do %>
  <span class="badge public">Public</span>
<% else %>
  <span class="badge private">Private</span>
<% end %>

<%# Or inline %>
<span class="badge"><%= if @snippet.is_public, do: "Public", else: "Private" %></span>
```

### Text with Line Breaks

```heex
<%# Preserve line breaks %>
<pre><%= @snippet.content %></pre>

<%# Convert newlines to <br> tags %>
<%= raw(String.replace(html_escape(@snippet.description), "\n", "<br>")) %>
```

> **FP Concept: View as Pure Function**
>
> Templates are conceptually pure functions:
>
> ```
> template(assigns) â†’ HTML string
> ```
>
> Given the same assigns, you always get the same HTML. This makes templates:
> - **Predictable**: Output depends only on input
> - **Testable**: Pass assigns, check output
> - **Cacheable**: Same input = same output
>
> **Further Reading**:
> - [Phoenix Templates](https://hexdocs.pm/phoenix/templates.html)

## Summary

In this chapter, we learned:

- Passing data from controller to template
- Displaying single records and collections
- Working with assigns
- Handling nil values and defaults
- Formatting different data types

In the next chapter, we'll build templates for all CRUD actions.

---

## Additional Information

### Debugging Templates

```heex
<%# Print variable for debugging %>
<pre><%= inspect(@snippet, pretty: true) %></pre>

<%# Check all assigns %>
<pre><%= inspect(assigns, pretty: true) %></pre>
```

### Common Pitfalls

1. **Unloaded associations**:
```heex
<%# This fails if user not preloaded %>
<%= @snippet.user.name %>
```

2. **Nil in template**:
```heex
<%# This outputs nothing for nil %>
<%= @nil_value %>

<%# This crashes on method call %>
<%= @nil_value.something %>
```
