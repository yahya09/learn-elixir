# Chapter 2.8: Serving Static Files

Every web application needs static assets - CSS, JavaScript, images, and fonts. In this chapter, we'll learn how Phoenix handles static files and the asset pipeline.

## Static Files in Phoenix

Phoenix serves static files from two locations:

1. **priv/static/** - Pre-built static assets
2. **assets/** - Source files processed by the asset pipeline

```
snippetbox/
├── assets/                    # Source files (processed)
│   ├── css/
│   │   └── app.css
│   ├── js/
│   │   └── app.js
│   └── vendor/                # Third-party libraries
│
├── priv/static/               # Output directory (served)
│   ├── assets/                # Compiled CSS/JS
│   │   ├── app.css
│   │   └── app.js
│   ├── images/                # Images
│   │   ├── logo.png
│   │   └── favicon.ico
│   ├── fonts/                 # Web fonts
│   └── robots.txt             # Robots file
```

## How Static File Serving Works

Phoenix's endpoint configuration handles static files:

```elixir
# File: lib/snippetbox_web/endpoint.ex

defmodule SnippetboxWeb.Endpoint do
  use Phoenix.Endpoint, otp_app: :snippetbox

  # Serve static files from priv/static
  plug Plug.Static,
    at: "/",
    from: :snippetbox,
    gzip: false,
    only: SnippetboxWeb.static_paths()

  # ... rest of endpoint
end
```

The `Plug.Static` configuration:
- `at: "/"` - URL prefix (serve at root)
- `from: :snippetbox` - App name (finds priv/static)
- `gzip: false` - Disable gzip (usually handled by CDN/proxy)
- `only:` - Whitelist of paths to serve

### Static Paths

```elixir
# File: lib/snippetbox_web.ex

def static_paths do
  ~w(assets fonts images favicon.ico robots.txt)
end
```

Only files in these directories/paths are served. This prevents accidental exposure of other files in `priv/static`.

## Adding Static Files

### Images

Place images directly in `priv/static/images/`:

```
priv/static/images/
├── logo.png
├── hero.jpg
└── icons/
    ├── github.svg
    └── twitter.svg
```

Reference in templates:

```heex
<img src={~p"/images/logo.png"} alt="Snippetbox Logo" />
<img src={~p"/images/icons/github.svg"} alt="GitHub" />
```

### Favicon

Place in `priv/static/`:

```
priv/static/
└── favicon.ico
```

Already referenced in root layout:

```heex
<link rel="icon" href={~p"/favicon.ico"} />
```

### Fonts

Create a fonts directory:

```
priv/static/fonts/
├── Inter-Regular.woff2
├── Inter-Bold.woff2
└── FiraCode-Regular.woff2
```

Reference in CSS:

```css
/* File: assets/css/app.css */

@font-face {
  font-family: 'Inter';
  src: url('/fonts/Inter-Regular.woff2') format('woff2');
  font-weight: 400;
}

@font-face {
  font-family: 'Inter';
  src: url('/fonts/Inter-Bold.woff2') format('woff2');
  font-weight: 700;
}

@font-face {
  font-family: 'Fira Code';
  src: url('/fonts/FiraCode-Regular.woff2') format('woff2');
}

body {
  font-family: 'Inter', sans-serif;
}

code, pre {
  font-family: 'Fira Code', monospace;
}
```

Don't forget to add "fonts" to static_paths:

```elixir
def static_paths do
  ~w(assets fonts images favicon.ico robots.txt)
end
```

### robots.txt

```
# File: priv/static/robots.txt

User-agent: *
Allow: /

Sitemap: https://snippetbox.example.com/sitemap.xml
```

## The Asset Pipeline

Phoenix uses **esbuild** for JavaScript and **Tailwind CSS** (optional) for CSS processing.

### CSS with esbuild

By default, Phoenix bundles CSS through esbuild:

```css
/* File: assets/css/app.css */

/* Import Tailwind or other frameworks */
@import "tailwindcss/base";
@import "tailwindcss/components";
@import "tailwindcss/utilities";

/* Your custom styles */
.snippet {
  background: #f8f9fa;
  border-radius: 4px;
  padding: 1rem;
  margin-bottom: 1rem;
}

.snippet-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.snippet-content {
  font-family: 'Fira Code', monospace;
  background: #282c34;
  color: #abb2bf;
  padding: 1rem;
  border-radius: 4px;
  overflow-x: auto;
}
```

### JavaScript with esbuild

```javascript
// File: assets/js/app.js

// Include Phoenix dependencies
import "phoenix_html"
import {Socket} from "phoenix"
import {LiveSocket} from "phoenix_live_view"
import topbar from "../vendor/topbar"

// Configure LiveSocket
let csrfToken = document.querySelector("meta[name='csrf-token']").getAttribute("content")
let liveSocket = new LiveSocket("/live", Socket, {params: {_csrf_token: csrfToken}})

// Show progress bar on live navigation
topbar.config({barColors: {0: "#29d"}, shadowColor: "rgba(0, 0, 0, .3)"})
window.addEventListener("phx:page-loading-start", _info => topbar.show(300))
window.addEventListener("phx:page-loading-stop", _info => topbar.hide())

// Connect LiveSocket
liveSocket.connect()
window.liveSocket = liveSocket

// Your custom JavaScript
document.addEventListener("DOMContentLoaded", () => {
  console.log("Snippetbox loaded!")

  // Copy to clipboard functionality
  document.querySelectorAll(".copy-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const code = btn.dataset.code
      await navigator.clipboard.writeText(code)
      btn.textContent = "Copied!"
      setTimeout(() => btn.textContent = "Copy", 2000)
    })
  })
})
```

### Asset Build Configuration

Phoenix configures esbuild in `config/config.exs`:

```elixir
# File: config/config.exs

config :esbuild,
  version: "0.17.11",
  default: [
    args: ~w(js/app.js --bundle --target=es2017 --outdir=../priv/static/assets
             --external:/fonts/* --external:/images/*),
    cd: Path.expand("../assets", __DIR__),
    env: %{"NODE_PATH" => Path.expand("../deps", __DIR__)}
  ]
```

And Tailwind (if using):

```elixir
config :tailwind,
  version: "3.3.2",
  default: [
    args: ~w(
      --config=tailwind.config.js
      --input=css/app.css
      --output=../priv/static/assets/app.css
    ),
    cd: Path.expand("../assets", __DIR__)
  ]
```

### Development Watchers

In development, assets are rebuilt automatically:

```elixir
# File: config/dev.exs

config :snippetbox, SnippetboxWeb.Endpoint,
  watchers: [
    esbuild: {Esbuild, :install_and_run, [:default, ~w(--sourcemap=inline --watch)]},
    tailwind: {Tailwind, :install_and_run, [:default, ~w(--watch)]}
  ]
```

## Referencing Assets in Templates

### Using Verified Routes

Always use `~p` for asset paths:

```heex
<%# CSS %>
<link rel="stylesheet" href={~p"/assets/app.css"} />

<%# JavaScript %>
<script src={~p"/assets/app.js"}></script>

<%# Images %>
<img src={~p"/images/logo.png"} alt="Logo" />
```

### Cache Busting

Phoenix automatically adds cache-busting digests in production. The `phx-track-static` attribute helps:

```heex
<link phx-track-static rel="stylesheet" href={~p"/assets/app.css"} />
<script defer phx-track-static src={~p"/assets/app.js"}></script>
```

In production, paths become:
```
/assets/app-a1b2c3d4.css
/assets/app-e5f6g7h8.js
```

## Vendor Libraries

Place third-party JavaScript in `assets/vendor/`:

```
assets/vendor/
├── topbar.js          # Progress bar (included by default)
├── highlight.min.js   # Syntax highlighting
└── alpine.min.js      # Alpine.js
```

Import in your app.js:

```javascript
// File: assets/js/app.js

import "../vendor/topbar"
import "../vendor/highlight.min"

// Initialize highlight.js
document.addEventListener("DOMContentLoaded", () => {
  hljs.highlightAll()
})
```

## Creating a Stylesheet

Let's create a complete stylesheet for Snippetbox:

```css
/* File: assets/css/app.css */

/* === Reset === */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* === Variables === */
:root {
  --color-primary: #4f46e5;
  --color-primary-dark: #4338ca;
  --color-bg: #ffffff;
  --color-bg-secondary: #f9fafb;
  --color-text: #111827;
  --color-text-secondary: #6b7280;
  --color-border: #e5e7eb;
  --color-success: #10b981;
  --color-error: #ef4444;
  --font-sans: 'Inter', system-ui, sans-serif;
  --font-mono: 'Fira Code', monospace;
}

/* === Base === */
html {
  font-size: 16px;
  line-height: 1.5;
}

body {
  font-family: var(--font-sans);
  color: var(--color-text);
  background: var(--color-bg);
}

a {
  color: var(--color-primary);
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* === Layout === */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
}

/* === Header === */
header {
  background: var(--color-bg-secondary);
  border-bottom: 1px solid var(--color-border);
  padding: 1rem 0;
}

header nav {
  display: flex;
  gap: 1.5rem;
  align-items: center;
}

header nav a {
  color: var(--color-text-secondary);
  font-weight: 500;
}

header nav a:hover {
  color: var(--color-primary);
  text-decoration: none;
}

/* === Main === */
main {
  padding: 2rem 0;
  min-height: calc(100vh - 200px);
}

/* === Snippets === */
.snippet {
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 1rem;
}

.snippet-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.snippet-meta {
  color: var(--color-text-secondary);
  font-size: 0.875rem;
  margin-bottom: 1rem;
}

.snippet-content {
  background: #1e1e1e;
  color: #d4d4d4;
  font-family: var(--font-mono);
  font-size: 0.875rem;
  padding: 1rem;
  border-radius: 4px;
  overflow-x: auto;
}

/* === Buttons === */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
  font-weight: 500;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: background-color 0.15s;
}

.btn-primary {
  background: var(--color-primary);
  color: white;
}

.btn-primary:hover {
  background: var(--color-primary-dark);
  text-decoration: none;
}

/* === Forms === */
.form-group {
  margin-bottom: 1rem;
}

.form-label {
  display: block;
  font-weight: 500;
  margin-bottom: 0.5rem;
}

.form-input {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: 1px solid var(--color-border);
  border-radius: 6px;
  font-size: 1rem;
}

.form-input:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

/* === Flash Messages === */
.flash {
  padding: 1rem;
  border-radius: 6px;
  margin-bottom: 1rem;
}

.flash-info {
  background: #eff6ff;
  color: #1e40af;
  border: 1px solid #bfdbfe;
}

.flash-error {
  background: #fef2f2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

/* === Footer === */
footer {
  background: var(--color-bg-secondary);
  border-top: 1px solid var(--color-border);
  padding: 1.5rem 0;
  text-align: center;
  color: var(--color-text-secondary);
}
```

## Production Asset Compilation

Build assets for production:

```bash
# Build assets with minification
$ MIX_ENV=prod mix assets.deploy
```

This runs:
1. esbuild with minification
2. Tailwind with minification (if configured)
3. Generates digest hashes for cache busting

The output goes to `priv/static/assets/` with fingerprinted filenames.

## Serving Files Programmatically

Sometimes you need to serve files from code:

```elixir
# File: lib/snippetbox_web/controllers/download_controller.ex

defmodule SnippetboxWeb.DownloadController do
  use SnippetboxWeb, :controller

  def snippet(conn, %{"id" => id}) do
    snippet = Snippets.get_snippet!(id)

    conn
    |> put_resp_content_type("text/plain")
    |> put_resp_header("content-disposition",
         "attachment; filename=\"snippet-#{id}.txt\"")
    |> send_resp(200, snippet.content)
  end

  def image(conn, %{"name" => name}) do
    path = Application.app_dir(:snippetbox, "priv/static/images/#{name}")

    if File.exists?(path) do
      send_file(conn, 200, path)
    else
      send_resp(conn, 404, "Not found")
    end
  end
end
```

> **FP Concept: Explicit over Implicit**
>
> Phoenix makes asset paths explicit with `~p`:
>
> ```heex
> <%# Explicit - compile-time verified %>
> <img src={~p"/images/logo.png"} />
>
> <%# vs implicit (Rails style) %>
> <%= image_tag "logo.png" %>
> ```
>
> The functional approach:
> - Paths are data, not magic
> - Compile-time verification catches typos
> - No hidden path resolution rules
> - Easier to understand and debug
>
> **Further Reading**:
> - [Phoenix Static Files Guide](https://hexdocs.pm/phoenix/static_assets.html)

## Summary

In this chapter, we learned:

- Phoenix's static file organization (`priv/static/` and `assets/`)
- How `Plug.Static` serves files
- Adding images, fonts, and other assets
- The asset pipeline with esbuild
- CSS and JavaScript organization
- Cache busting for production

In the next chapter, we'll explore the controller pattern in more depth.

---

## Additional Information

### Common Asset Tasks

```bash
# Watch and rebuild assets in development
$ mix phx.server  # Automatically watches assets

# Build assets once
$ mix assets.build

# Build for production (minified + digested)
$ MIX_ENV=prod mix assets.deploy

# Install asset dependencies
$ mix assets.setup
```

### Comparing to Other Frameworks

**Rails Asset Pipeline**:
```ruby
# Sprockets/Propshaft handles assets
# Magic methods in views
<%= stylesheet_link_tag "application" %>
<%= javascript_include_tag "application" %>
```

**Django Static Files**:
```python
# settings.py
STATIC_URL = '/static/'
STATICFILES_DIRS = [BASE_DIR / "static"]

# Template
{% load static %}
<img src="{% static 'images/logo.png' %}">
```

**Laravel Mix**:
```php
// webpack.mix.js for compilation
<link href="{{ mix('css/app.css') }}" rel="stylesheet">
```

**Phoenix**:
```elixir
# esbuild for bundling, explicit paths
<link rel="stylesheet" href={~p"/assets/app.css"} />
```

Phoenix's approach is simpler - esbuild handles bundling, and paths are explicit.
