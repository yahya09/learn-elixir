# Chapter 13.3: Integration Testing

Integration tests verify that multiple components work together correctly. In this chapter, we'll explore end-to-end testing with Wallaby.

## Wallaby Setup

### Installation

```elixir
# File: mix.exs

defp deps do
  [
    {:wallaby, "~> 0.30", only: :test, runtime: false}
  ]
end
```

### Configuration

```elixir
# File: config/test.exs

config :wallaby,
  driver: Wallaby.Chrome,
  screenshot_on_failure: true,
  js_logger: :stdio

config :snippetbox, SnippetboxWeb.Endpoint,
  server: true
```

```elixir
# File: test/test_helper.exs

{:ok, _} = Application.ensure_all_started(:wallaby)
Application.put_env(:wallaby, :base_url, SnippetboxWeb.Endpoint.url())
ExUnit.start()
Ecto.Adapters.SQL.Sandbox.mode(Snippetbox.Repo, :manual)
```

### Feature Case

```elixir
# File: test/support/feature_case.ex

defmodule SnippetboxWeb.FeatureCase do
  use ExUnit.CaseTemplate

  using do
    quote do
      use Wallaby.Feature

      alias SnippetboxWeb.Router.Helpers, as: Routes
      import Snippetbox.AccountsFixtures
      import Snippetbox.SnippetsFixtures
    end
  end

  setup tags do
    :ok = Ecto.Adapters.SQL.Sandbox.checkout(Snippetbox.Repo)

    unless tags[:async] do
      Ecto.Adapters.SQL.Sandbox.mode(Snippetbox.Repo, {:shared, self()})
    end

    metadata = Phoenix.Ecto.SQL.Sandbox.metadata_for(Snippetbox.Repo, self())
    {:ok, session} = Wallaby.start_session(metadata: metadata)

    {:ok, session: session}
  end
end
```

## Basic Feature Tests

```elixir
# File: test/snippetbox_web/features/homepage_test.exs

defmodule SnippetboxWeb.Features.HomepageTest do
  use SnippetboxWeb.FeatureCase

  feature "user visits homepage", %{session: session} do
    session
    |> visit("/")
    |> assert_has(Query.css("h1", text: "Welcome to Snippetbox"))
    |> assert_has(Query.link("Browse Snippets"))
  end

  feature "user can navigate to snippets", %{session: session} do
    session
    |> visit("/")
    |> click(Query.link("Browse Snippets"))
    |> assert_has(Query.css("h1", text: "Snippets"))
  end
end
```

## Testing User Flows

### Registration Flow

```elixir
# File: test/snippetbox_web/features/registration_test.exs

defmodule SnippetboxWeb.Features.RegistrationTest do
  use SnippetboxWeb.FeatureCase

  feature "user can register", %{session: session} do
    session
    |> visit("/register")
    |> fill_in(Query.text_field("Email"), with: "new@example.com")
    |> fill_in(Query.text_field("Password"), with: "password123456")
    |> click(Query.button("Create Account"))
    |> assert_has(Query.css(".alert-info", text: "Account created"))
  end

  feature "shows validation errors", %{session: session} do
    session
    |> visit("/register")
    |> fill_in(Query.text_field("Email"), with: "invalid")
    |> fill_in(Query.text_field("Password"), with: "short")
    |> click(Query.button("Create Account"))
    |> assert_has(Query.css(".phx-form-error", text: "must have the @ sign"))
    |> assert_has(Query.css(".phx-form-error", text: "should be at least"))
  end
end
```

### Login Flow

```elixir
# File: test/snippetbox_web/features/login_test.exs

defmodule SnippetboxWeb.Features.LoginTest do
  use SnippetboxWeb.FeatureCase

  feature "user can login", %{session: session} do
    user = user_fixture()

    session
    |> visit("/login")
    |> fill_in(Query.text_field("Email"), with: user.email)
    |> fill_in(Query.text_field("Password"), with: valid_user_password())
    |> click(Query.button("Log in"))
    |> assert_has(Query.css(".alert-info", text: "Welcome back"))
    |> assert_has(Query.text(user.email))
  end

  feature "shows error for invalid credentials", %{session: session} do
    session
    |> visit("/login")
    |> fill_in(Query.text_field("Email"), with: "wrong@example.com")
    |> fill_in(Query.text_field("Password"), with: "wrongpassword")
    |> click(Query.button("Log in"))
    |> assert_has(Query.css(".alert-error", text: "Invalid email or password"))
  end

  feature "user can logout", %{session: session} do
    user = user_fixture()

    session
    |> login(user)
    |> click(Query.link("Log out"))
    |> assert_has(Query.link("Log in"))
  end

  defp login(session, user) do
    session
    |> visit("/login")
    |> fill_in(Query.text_field("Email"), with: user.email)
    |> fill_in(Query.text_field("Password"), with: valid_user_password())
    |> click(Query.button("Log in"))
  end
end
```

## Testing CRUD Operations

```elixir
# File: test/snippetbox_web/features/snippet_crud_test.exs

defmodule SnippetboxWeb.Features.SnippetCRUDTest do
  use SnippetboxWeb.FeatureCase

  setup %{session: session} do
    user = user_fixture()
    session = login(session, user)
    {:ok, session: session, user: user}
  end

  feature "user creates a snippet", %{session: session} do
    session
    |> visit("/snippets/new")
    |> fill_in(Query.text_field("Title"), with: "My Test Snippet")
    |> fill_in(Query.css("textarea[name='snippet[content]']"), with: "defmodule Test do\nend")
    |> select(Query.select("Language"), option: "elixir")
    |> click(Query.button("Save Snippet"))
    |> assert_has(Query.css(".alert-info", text: "created"))
    |> assert_has(Query.css("h1", text: "My Test Snippet"))
  end

  feature "user views a snippet", %{session: session, user: user} do
    snippet = snippet_fixture(%{user_id: user.id, title: "View Test"})

    session
    |> visit("/snippets/#{snippet.id}")
    |> assert_has(Query.css("h1", text: "View Test"))
    |> assert_has(Query.css("code", text: snippet.content))
  end

  feature "user edits a snippet", %{session: session, user: user} do
    snippet = snippet_fixture(%{user_id: user.id})

    session
    |> visit("/snippets/#{snippet.id}/edit")
    |> clear(Query.text_field("Title"))
    |> fill_in(Query.text_field("Title"), with: "Updated Title")
    |> click(Query.button("Save Snippet"))
    |> assert_has(Query.css(".alert-info", text: "updated"))
    |> assert_has(Query.css("h1", text: "Updated Title"))
  end

  feature "user deletes a snippet", %{session: session, user: user} do
    snippet = snippet_fixture(%{user_id: user.id, title: "Delete Me"})

    session
    |> visit("/snippets/#{snippet.id}")
    |> accept_confirm(fn s -> click(s, Query.button("Delete")) end)
    |> assert_has(Query.css(".alert-info", text: "deleted"))
    |> refute_has(Query.text("Delete Me"))
  end

  defp login(session, user) do
    session
    |> visit("/login")
    |> fill_in(Query.text_field("Email"), with: user.email)
    |> fill_in(Query.text_field("Password"), with: valid_user_password())
    |> click(Query.button("Log in"))
  end
end
```

## Testing Search

```elixir
# File: test/snippetbox_web/features/search_test.exs

defmodule SnippetboxWeb.Features.SearchTest do
  use SnippetboxWeb.FeatureCase

  feature "user searches snippets", %{session: session} do
    snippet_fixture(%{title: "Elixir GenServer Example"})
    snippet_fixture(%{title: "Python Script"})

    session
    |> visit("/snippets")
    |> fill_in(Query.text_field("Search"), with: "GenServer")
    |> click(Query.button("Search"))
    |> assert_has(Query.text("Elixir GenServer Example"))
    |> refute_has(Query.text("Python Script"))
  end

  feature "search with no results", %{session: session} do
    session
    |> visit("/snippets")
    |> fill_in(Query.text_field("Search"), with: "nonexistent")
    |> click(Query.button("Search"))
    |> assert_has(Query.text("No snippets found"))
  end
end
```

## Testing JavaScript Interactions

```elixir
# File: test/snippetbox_web/features/javascript_test.exs

defmodule SnippetboxWeb.Features.JavaScriptTest do
  use SnippetboxWeb.FeatureCase

  feature "modal opens and closes", %{session: session} do
    session
    |> visit("/snippets")
    |> click(Query.button("New Snippet"))
    |> assert_has(Query.css("#snippet-modal", visible: true))
    |> click(Query.css("[data-close-modal]"))
    |> assert_has(Query.css("#snippet-modal", visible: false))
  end

  feature "dropdown menu works", %{session: session} do
    user = user_fixture()

    session
    |> login(user)
    |> visit("/")
    |> click(Query.css("[data-dropdown-toggle]"))
    |> assert_has(Query.css("[data-dropdown-menu]", visible: true))
    |> click(Query.link("Profile"))
    |> assert_has(Query.css("h1", text: "Profile"))
  end

  feature "copy to clipboard shows feedback", %{session: session} do
    snippet = snippet_fixture()

    session
    |> visit("/snippets/#{snippet.id}")
    |> click(Query.button("Copy"))
    |> assert_has(Query.text("Copied!"))
  end
end
```

## Testing Forms with Validation

```elixir
# File: test/snippetbox_web/features/form_validation_test.exs

defmodule SnippetboxWeb.Features.FormValidationTest do
  use SnippetboxWeb.FeatureCase

  setup %{session: session} do
    user = user_fixture()
    session = login(session, user)
    {:ok, session: session}
  end

  feature "real-time validation shows errors", %{session: session} do
    session
    |> visit("/snippets/new")
    |> fill_in(Query.text_field("Title"), with: "")
    |> click(Query.css("body"))  # Trigger blur
    |> assert_has(Query.css(".phx-form-error", text: "can't be blank"))
  end

  feature "validation clears on valid input", %{session: session} do
    session
    |> visit("/snippets/new")
    |> fill_in(Query.text_field("Title"), with: "")
    |> click(Query.css("body"))
    |> assert_has(Query.css(".phx-form-error"))
    |> fill_in(Query.text_field("Title"), with: "Valid Title")
    |> refute_has(Query.css(".phx-form-error"))
  end
end
```

## Page Objects Pattern

```elixir
# File: test/support/pages/snippet_page.ex

defmodule SnippetboxWeb.Pages.SnippetPage do
  use Wallaby.DSL

  def visit_index(session) do
    visit(session, "/snippets")
  end

  def visit_new(session) do
    visit(session, "/snippets/new")
  end

  def visit_show(session, snippet) do
    visit(session, "/snippets/#{snippet.id}")
  end

  def fill_form(session, attrs) do
    session
    |> fill_in(Query.text_field("Title"), with: attrs[:title] || "")
    |> fill_in(Query.css("textarea[name='snippet[content]']"), with: attrs[:content] || "")
    |> select(Query.select("Language"), option: attrs[:language] || "elixir")
  end

  def submit_form(session) do
    click(session, Query.button("Save Snippet"))
  end

  def assert_snippet_displayed(session, snippet) do
    session
    |> assert_has(Query.css("h1", text: snippet.title))
    |> assert_has(Query.css("code", text: snippet.content))
  end

  def click_edit(session) do
    click(session, Query.link("Edit"))
  end

  def click_delete(session) do
    accept_confirm(session, fn s ->
      click(s, Query.button("Delete"))
    end)
  end
end

# Usage
defmodule SnippetboxWeb.Features.SnippetPageObjectTest do
  use SnippetboxWeb.FeatureCase

  alias SnippetboxWeb.Pages.SnippetPage

  feature "creates snippet using page object", %{session: session} do
    user = user_fixture()

    session
    |> login(user)
    |> SnippetPage.visit_new()
    |> SnippetPage.fill_form(%{
      title: "Page Object Test",
      content: "defmodule Test do\nend",
      language: "elixir"
    })
    |> SnippetPage.submit_form()
    |> assert_has(Query.css(".alert-info", text: "created"))
  end
end
```

## Testing File Uploads

```elixir
feature "user uploads file", %{session: session} do
  session
  |> login(user_fixture())
  |> visit("/snippets/import")
  |> attach_file(Query.file_field("file"), path: "test/fixtures/sample.ex")
  |> click(Query.button("Import"))
  |> assert_has(Query.css(".alert-info", text: "imported"))
end
```

## Screenshots on Failure

```elixir
# File: config/test.exs

config :wallaby,
  screenshot_on_failure: true,
  screenshot_dir: "tmp/screenshots"
```

```elixir
# Manual screenshots
feature "captures screenshot", %{session: session} do
  session
  |> visit("/")
  |> take_screenshot(name: "homepage")
end
```

> **FP Concept: Session Transformation**
>
> Wallaby tests follow the functional pattern of session transformation:
>
> ```elixir
> session
> |> visit("/page")           # Returns new session
> |> fill_in(field, value)    # Returns new session
> |> click(button)            # Returns new session
> |> assert_has(element)      # Returns new session
>
> # Each action transforms the session state
> # The original session is never modified
> ```
>
> This makes test steps composable and easy to reason about.

## Summary

In this chapter, we learned:

- Setting up Wallaby for integration tests
- Writing feature tests
- Testing user flows (registration, login)
- Testing CRUD operations
- Testing JavaScript interactions
- Page objects pattern
- Testing file uploads
- Screenshots for debugging

In the next chapter, we'll explore LiveView testing.
