# Chapter 3.4: Custom Error Pages

In the previous chapter, we covered error handling basics. Now we'll create polished, user-friendly error pages that maintain your application's look and feel.

## Error Page Requirements

Good error pages should:

1. **Match your design** - Same branding as the rest of your app
2. **Be helpful** - Tell users what happened and what to do
3. **Be self-contained** - Work even if assets fail to load
4. **Not leak information** - Hide technical details in production

## Standalone vs Layout-Based Error Pages

### Standalone (Recommended)

Error pages with inline CSS don't depend on external assets:

```heex
<%# File: lib/snippetbox_web/controllers/error_html/404.html.heex %>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Not Found - Snippetbox</title>
  <style>
    /* Inline styles ensure page works even if CSS fails */
    :root {
      --primary: #4f46e5;
      --gray-50: #f9fafb;
      --gray-600: #4b5563;
      --gray-900: #111827;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--gray-50);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 1rem 2rem;
    }

    .logo {
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--primary);
      text-decoration: none;
    }

    main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .error-container {
      text-align: center;
      max-width: 500px;
    }

    .error-code {
      font-size: 8rem;
      font-weight: 700;
      color: var(--primary);
      line-height: 1;
    }

    .error-title {
      font-size: 1.5rem;
      color: var(--gray-900);
      margin: 1rem 0;
    }

    .error-message {
      color: var(--gray-600);
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      background: var(--primary);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 500;
      transition: background 0.15s;
    }

    .btn:hover {
      background: #4338ca;
    }

    .links {
      margin-top: 1.5rem;
    }

    .links a {
      color: var(--primary);
      text-decoration: none;
      margin: 0 0.5rem;
    }

    .links a:hover {
      text-decoration: underline;
    }

    footer {
      text-align: center;
      padding: 1.5rem;
      color: var(--gray-600);
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <header>
    <a href="/" class="logo">Snippetbox</a>
  </header>

  <main>
    <div class="error-container">
      <div class="error-code">404</div>
      <h1 class="error-title">Page Not Found</h1>
      <p class="error-message">
        The page you're looking for doesn't exist or has been moved.
        Check the URL or navigate using the links below.
      </p>
      <a href="/" class="btn">Go to Homepage</a>
      <div class="links">
        <a href="/snippets">Browse Snippets</a>
        <a href="/about">About</a>
        <a href="/contact">Contact</a>
      </div>
    </div>
  </main>

  <footer>
    &copy; 2024 Snippetbox. All rights reserved.
  </footer>
</body>
</html>
```

### Layout-Based (Optional)

If you want error pages to use your app layout:

```elixir
# File: config/config.exs

config :snippetbox, SnippetboxWeb.Endpoint,
  render_errors: [
    formats: [html: SnippetboxWeb.ErrorHTML, json: SnippetboxWeb.ErrorJSON],
    layout: {SnippetboxWeb.Layouts, :error}  # Use error layout
  ]
```

```heex
<%# File: lib/snippetbox_web/components/layouts/error.html.heex %>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= assigns[:page_title] || "Error" %> - Snippetbox</title>
  <%# Include compiled CSS %>
  <link rel="stylesheet" href="/assets/app.css">
</head>
<body>
  <header>
    <nav class="container">
      <a href="/" class="logo">Snippetbox</a>
    </nav>
  </header>

  <main class="container">
    <%= @inner_content %>
  </main>

  <footer class="container">
    <p>&copy; 2024 Snippetbox</p>
  </footer>
</body>
</html>
```

## Complete Error Pages

### 404 - Not Found

```heex
<%# File: lib/snippetbox_web/controllers/error_html/404.html.heex %>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Page Not Found - Snippetbox</title>
  <style>
    :root { --primary: #4f46e5; --bg: #f9fafb; --text: #111827; --muted: #6b7280; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: var(--bg); min-height: 100vh;
           display: flex; flex-direction: column; }
    header { background: white; border-bottom: 1px solid #e5e7eb; padding: 1rem 2rem; }
    .logo { font-weight: 700; font-size: 1.25rem; color: var(--primary); text-decoration: none; }
    main { flex: 1; display: flex; align-items: center; justify-content: center; padding: 2rem; }
    .error { text-align: center; max-width: 500px; }
    .code { font-size: 8rem; font-weight: 700; color: var(--primary); line-height: 1; }
    h1 { font-size: 1.5rem; color: var(--text); margin: 1rem 0; }
    p { color: var(--muted); margin-bottom: 2rem; line-height: 1.6; }
    .btn { display: inline-block; padding: 0.75rem 1.5rem; background: var(--primary);
           color: white; text-decoration: none; border-radius: 6px; font-weight: 500; }
    .btn:hover { background: #4338ca; }
    footer { text-align: center; padding: 1.5rem; color: var(--muted); font-size: 0.875rem; }
  </style>
</head>
<body>
  <header><a href="/" class="logo">Snippetbox</a></header>
  <main>
    <div class="error">
      <div class="code">404</div>
      <h1>Page Not Found</h1>
      <p>Sorry, the page you're looking for doesn't exist or may have been moved.</p>
      <a href="/" class="btn">Back to Home</a>
    </div>
  </main>
  <footer>&copy; 2024 Snippetbox</footer>
</body>
</html>
```

### 500 - Server Error

```heex
<%# File: lib/snippetbox_web/controllers/error_html/500.html.heex %>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Server Error - Snippetbox</title>
  <style>
    :root { --danger: #ef4444; --bg: #f9fafb; --text: #111827; --muted: #6b7280; --primary: #4f46e5; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: var(--bg); min-height: 100vh;
           display: flex; flex-direction: column; }
    header { background: white; border-bottom: 1px solid #e5e7eb; padding: 1rem 2rem; }
    .logo { font-weight: 700; font-size: 1.25rem; color: var(--primary); text-decoration: none; }
    main { flex: 1; display: flex; align-items: center; justify-content: center; padding: 2rem; }
    .error { text-align: center; max-width: 500px; }
    .code { font-size: 8rem; font-weight: 700; color: var(--danger); line-height: 1; }
    h1 { font-size: 1.5rem; color: var(--text); margin: 1rem 0; }
    p { color: var(--muted); margin-bottom: 2rem; line-height: 1.6; }
    .btn { display: inline-block; padding: 0.75rem 1.5rem; background: var(--primary);
           color: white; text-decoration: none; border-radius: 6px; font-weight: 500; }
    .btn:hover { background: #4338ca; }
    .retry { margin-top: 1rem; }
    .retry a { color: var(--primary); text-decoration: none; }
    footer { text-align: center; padding: 1.5rem; color: var(--muted); font-size: 0.875rem; }
  </style>
</head>
<body>
  <header><a href="/" class="logo">Snippetbox</a></header>
  <main>
    <div class="error">
      <div class="code">500</div>
      <h1>Something Went Wrong</h1>
      <p>We're experiencing technical difficulties. Our team has been notified and is working on it.</p>
      <a href="/" class="btn">Back to Home</a>
      <p class="retry">Or <a href="javascript:location.reload()">try refreshing the page</a></p>
    </div>
  </main>
  <footer>&copy; 2024 Snippetbox</footer>
</body>
</html>
```

### 403 - Forbidden

```heex
<%# File: lib/snippetbox_web/controllers/error_html/403.html.heex %>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Access Denied - Snippetbox</title>
  <style>
    :root { --warning: #f59e0b; --bg: #f9fafb; --text: #111827; --muted: #6b7280; --primary: #4f46e5; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: var(--bg); min-height: 100vh;
           display: flex; flex-direction: column; }
    header { background: white; border-bottom: 1px solid #e5e7eb; padding: 1rem 2rem; }
    .logo { font-weight: 700; font-size: 1.25rem; color: var(--primary); text-decoration: none; }
    main { flex: 1; display: flex; align-items: center; justify-content: center; padding: 2rem; }
    .error { text-align: center; max-width: 500px; }
    .code { font-size: 8rem; font-weight: 700; color: var(--warning); line-height: 1; }
    h1 { font-size: 1.5rem; color: var(--text); margin: 1rem 0; }
    p { color: var(--muted); margin-bottom: 2rem; line-height: 1.6; }
    .btn { display: inline-block; padding: 0.75rem 1.5rem; background: var(--primary);
           color: white; text-decoration: none; border-radius: 6px; font-weight: 500; }
    .btn:hover { background: #4338ca; }
    footer { text-align: center; padding: 1.5rem; color: var(--muted); font-size: 0.875rem; }
  </style>
</head>
<body>
  <header><a href="/" class="logo">Snippetbox</a></header>
  <main>
    <div class="error">
      <div class="code">403</div>
      <h1>Access Denied</h1>
      <p>You don't have permission to access this resource. Please log in or contact support if you believe this is an error.</p>
      <a href="/login" class="btn">Log In</a>
    </div>
  </main>
  <footer>&copy; 2024 Snippetbox</footer>
</body>
</html>
```

### 401 - Unauthorized

```heex
<%# File: lib/snippetbox_web/controllers/error_html/401.html.heex %>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login Required - Snippetbox</title>
  <style>
    :root { --info: #3b82f6; --bg: #f9fafb; --text: #111827; --muted: #6b7280; --primary: #4f46e5; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: var(--bg); min-height: 100vh;
           display: flex; flex-direction: column; }
    header { background: white; border-bottom: 1px solid #e5e7eb; padding: 1rem 2rem; }
    .logo { font-weight: 700; font-size: 1.25rem; color: var(--primary); text-decoration: none; }
    main { flex: 1; display: flex; align-items: center; justify-content: center; padding: 2rem; }
    .error { text-align: center; max-width: 500px; }
    .code { font-size: 8rem; font-weight: 700; color: var(--info); line-height: 1; }
    h1 { font-size: 1.5rem; color: var(--text); margin: 1rem 0; }
    p { color: var(--muted); margin-bottom: 2rem; line-height: 1.6; }
    .btn { display: inline-block; padding: 0.75rem 1.5rem; background: var(--primary);
           color: white; text-decoration: none; border-radius: 6px; font-weight: 500; }
    .btn:hover { background: #4338ca; }
    .signup { margin-top: 1rem; color: var(--muted); }
    .signup a { color: var(--primary); text-decoration: none; }
    footer { text-align: center; padding: 1.5rem; color: var(--muted); font-size: 0.875rem; }
  </style>
</head>
<body>
  <header><a href="/" class="logo">Snippetbox</a></header>
  <main>
    <div class="error">
      <div class="code">401</div>
      <h1>Login Required</h1>
      <p>You need to be logged in to access this page.</p>
      <a href="/login" class="btn">Log In</a>
      <p class="signup">Don't have an account? <a href="/signup">Sign up</a></p>
    </div>
  </main>
  <footer>&copy; 2024 Snippetbox</footer>
</body>
</html>
```

## Error HTML Module with All Templates

```elixir
# File: lib/snippetbox_web/controllers/error_html.ex

defmodule SnippetboxWeb.ErrorHTML do
  @moduledoc """
  Error pages for HTML responses.

  Each template (404.html.heex, 500.html.heex, etc.) is self-contained
  with inline styles to work even if CSS assets fail to load.
  """

  use SnippetboxWeb, :html

  embed_templates "error_html/*"

  # Fallback for any status code without a template
  def render(template, _assigns) do
    Phoenix.Controller.status_message_from_template(template)
  end
end
```

## Testing Error Pages

### View Test

```elixir
# File: test/snippetbox_web/controllers/error_html_test.exs

defmodule SnippetboxWeb.ErrorHTMLTest do
  use SnippetboxWeb.ConnCase, async: true

  import Phoenix.Template

  test "renders 404.html" do
    html = render_to_string(SnippetboxWeb.ErrorHTML, "404", "html", [])
    assert html =~ "404"
    assert html =~ "Page Not Found"
    assert html =~ "Back to Home"
  end

  test "renders 500.html" do
    html = render_to_string(SnippetboxWeb.ErrorHTML, "500", "html", [])
    assert html =~ "500"
    assert html =~ "Something Went Wrong"
  end

  test "renders 403.html" do
    html = render_to_string(SnippetboxWeb.ErrorHTML, "403", "html", [])
    assert html =~ "403"
    assert html =~ "Access Denied"
  end

  test "renders 401.html" do
    html = render_to_string(SnippetboxWeb.ErrorHTML, "401", "html", [])
    assert html =~ "401"
    assert html =~ "Login Required"
  end
end
```

### Integration Test

```elixir
# File: test/snippetbox_web/controllers/error_integration_test.exs

defmodule SnippetboxWeb.ErrorIntegrationTest do
  use SnippetboxWeb.ConnCase

  test "404 for non-existent route", %{conn: conn} do
    conn = get(conn, "/this-route-does-not-exist")
    assert html_response(conn, 404) =~ "Page Not Found"
  end

  test "404 for non-existent snippet", %{conn: conn} do
    assert_error_sent 404, fn ->
      get(conn, ~p"/snippets/999999999")
    end
  end
end
```

## Adding Error Tracking

Send errors to a monitoring service:

```elixir
# File: lib/snippetbox_web/controllers/error_html.ex

defmodule SnippetboxWeb.ErrorHTML do
  use SnippetboxWeb, :html

  embed_templates "error_html/*"

  def render("500.html", assigns) do
    # Report to error tracking service
    if reason = assigns[:reason] do
      Sentry.capture_exception(reason)
      # Or: Honeybadger.notify(reason)
      # Or: Rollbar.report(reason)
    end

    # Render the template
    render("500.html", assigns)
  end

  def render(template, _assigns) do
    Phoenix.Controller.status_message_from_template(template)
  end
end
```

> **Design Principle: Error Pages as Marketing**
>
> Error pages are often overlooked, but they're an opportunity:
>
> - **Show personality**: A friendly error page builds trust
> - **Reduce frustration**: Clear next steps help users
> - **Maintain brand**: Consistent design feels professional
> - **Recover users**: Links to popular pages reduce bounce
>
> Examples of great error pages:
> - GitHub's 404 shows a star wars reference
> - Pixar's 404 shows Sadness from Inside Out
> - Slack's error page is apologetic and helpful

## Summary

In this chapter, we learned:

- Creating standalone vs layout-based error pages
- Building custom 404, 500, 403, and 401 pages
- Inline CSS for self-contained error pages
- Testing error pages
- Error tracking integration

In the next chapter, we'll explore logging and debugging.

---

## Additional Information

### Static Error Pages for Nginx

For complete resilience, create static HTML error pages:

```nginx
# nginx.conf
error_page 502 503 504 /50x.html;
location = /50x.html {
    root /var/www/html/errors;
    internal;
}
```

This shows a static page even if Phoenix is down.

### Error Page Checklist

- [ ] 404 page with helpful navigation
- [ ] 500 page with reassuring message
- [ ] 403 page with login link
- [ ] 401 page with signup option
- [ ] Consistent branding on all pages
- [ ] Mobile-responsive design
- [ ] Works without external CSS/JS
- [ ] Contact information or support link
- [ ] Error tracking integration
