# Chapter 5.3: Iterating Collections

Displaying lists of data is a common task. In this chapter, we'll explore patterns for iterating over collections in templates.

## Basic Iteration

### The for Comprehension

```heex
<ul>
  <%= for item <- @items do %>
    <li><%= item.name %></li>
  <% end %>
</ul>
```

### With Index

```heex
<ol>
  <%= for {item, index} <- Enum.with_index(@items) do %>
    <li>
      <span class="number"><%= index + 1 %>.</span>
      <%= item.name %>
    </li>
  <% end %>
</ol>
```

### With First/Last Detection

```heex
<%= for {item, index} <- Enum.with_index(@items) do %>
  <div class={[
    "item",
    index == 0 && "first",
    index == length(@items) - 1 && "last"
  ]}>
    <%= item.name %>
  </div>
<% end %>
```

## Filtering in Loops

```heex
<%# Only public snippets %>
<%= for snippet <- @snippets, snippet.is_public do %>
  <div><%= snippet.title %></div>
<% end %>

<%# With multiple conditions %>
<%= for snippet <- @snippets,
        snippet.is_public,
        snippet.language == "elixir" do %>
  <div><%= snippet.title %></div>
<% end %>
```

## Empty State Handling

### Check Before Loop

```heex
<%= if Enum.empty?(@snippets) do %>
  <div class="empty-state">
    <h2>No snippets found</h2>
    <p>Be the first to create one!</p>
    <a href={~p"/snippets/new"} class="btn">Create Snippet</a>
  </div>
<% else %>
  <div class="snippets">
    <%= for snippet <- @snippets do %>
      <div class="snippet"><%= snippet.title %></div>
    <% end %>
  </div>
<% end %>
```

### Using case

```heex
<%= case @snippets do %>
  <% [] -> %>
    <div class="empty-state">No snippets found</div>

  <% [single] -> %>
    <div class="single-result">
      Found one snippet: <%= single.title %>
    </div>

  <% snippets -> %>
    <div class="snippets">
      Found <%= length(snippets) %> snippets:
      <%= for s <- snippets do %>
        <div><%= s.title %></div>
      <% end %>
    </div>
<% end %>
```

## Table Rendering

### Basic Table

```heex
<table class="table">
  <thead>
    <tr>
      <th>Title</th>
      <th>Language</th>
      <th>Created</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <%= for snippet <- @snippets do %>
      <tr>
        <td><%= snippet.title %></td>
        <td><%= snippet.language %></td>
        <td><%= format_date(snippet.inserted_at) %></td>
        <td>
          <a href={~p"/snippets/#{snippet}"}>View</a>
          <a href={~p"/snippets/#{snippet}/edit"}>Edit</a>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
```

### Striped Rows

```heex
<tbody>
  <%= for {snippet, index} <- Enum.with_index(@snippets) do %>
    <tr class={if rem(index, 2) == 0, do: "even", else: "odd"}>
      <td><%= snippet.title %></td>
    </tr>
  <% end %>
</tbody>
```

### Empty Table State

```heex
<table class="table">
  <thead>
    <tr>
      <th>Title</th>
      <th>Language</th>
    </tr>
  </thead>
  <tbody>
    <%= if Enum.empty?(@snippets) do %>
      <tr>
        <td colspan="2" class="empty-row">
          No snippets found
        </td>
      </tr>
    <% else %>
      <%= for snippet <- @snippets do %>
        <tr>
          <td><%= snippet.title %></td>
          <td><%= snippet.language %></td>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>
```

## Card Grid Layout

```heex
<div class="card-grid">
  <%= for snippet <- @snippets do %>
    <article class="card">
      <header class="card-header">
        <h3><%= snippet.title %></h3>
        <span class="badge"><%= snippet.language %></span>
      </header>
      <div class="card-body">
        <pre><%= truncate(snippet.content, 200) %></pre>
      </div>
      <footer class="card-footer">
        <span><%= time_ago(snippet.inserted_at) %></span>
        <a href={~p"/snippets/#{snippet}"}>View</a>
      </footer>
    </article>
  <% end %>
</div>
```

## Nested Iteration

### Snippets with Tags

```heex
<%= for snippet <- @snippets do %>
  <article class="snippet">
    <h2><%= snippet.title %></h2>
    <div class="tags">
      <%= for tag <- snippet.tags do %>
        <span class="tag"><%= tag.name %></span>
      <% end %>
    </div>
  </article>
<% end %>
```

### Grouped Data

```heex
<%# Group snippets by language %>
<% grouped = Enum.group_by(@snippets, & &1.language) %>

<%= for {language, snippets} <- grouped do %>
  <section class="language-group">
    <h2><%= language %> (<%= length(snippets) %>)</h2>
    <ul>
      <%= for snippet <- snippets do %>
        <li><%= snippet.title %></li>
      <% end %>
    </ul>
  </section>
<% end %>
```

## List with Separators

### Comma-Separated

```heex
<%= for {tag, index} <- Enum.with_index(@tags) do %>
  <%= if index > 0, do: ", " %><%= tag.name %>
<% end %>
```

### Using Intersperse

```elixir
# In view helper
def join_tags(tags) do
  tags
  |> Enum.map(& &1.name)
  |> Enum.intersperse(", ")
end
```

```heex
<%= join_tags(@snippet.tags) %>
```

## Pagination Display

```heex
<nav class="pagination" aria-label="Pagination">
  <%= if @page > 1 do %>
    <a href={~p"/snippets?#{[page: @page - 1]}"} class="page-link">
      &laquo; Previous
    </a>
  <% end %>

  <%= for page_num <- max(1, @page - 2)..min(@total_pages, @page + 2) do %>
    <%= if page_num == @page do %>
      <span class="page-link current"><%= page_num %></span>
    <% else %>
      <a href={~p"/snippets?#{[page: page_num]}"} class="page-link">
        <%= page_num %>
      </a>
    <% end %>
  <% end %>

  <%= if @page < @total_pages do %>
    <a href={~p"/snippets?#{[page: @page + 1]}"} class="page-link">
      Next &raquo;
    </a>
  <% end %>
</nav>
```

## Conditional Classes in Loops

```heex
<%= for snippet <- @snippets do %>
  <div class={[
    "snippet",
    snippet.is_public && "public",
    snippet.is_featured && "featured",
    expired?(snippet) && "expired"
  ]}>
    <%= snippet.title %>
  </div>
<% end %>
```

## Performance: Chunking Large Lists

```heex
<%# Render in columns %>
<% columns = Enum.chunk_every(@snippets, 3) %>

<div class="row">
  <%= for column <- columns do %>
    <div class="col">
      <%= for snippet <- column do %>
        <div class="snippet"><%= snippet.title %></div>
      <% end %>
    </div>
  <% end %>
</div>
```

> **FP Concept: List Comprehensions**
>
> The `for` comprehension in Elixir is a powerful tool that combines mapping, filtering, and collecting:
>
> ```elixir
> # Map and filter in one expression
> for snippet <- snippets,
>     snippet.is_public,
>     snippet.language == "elixir",
>     do: snippet.title
> ```
>
> In templates, this becomes:
>
> ```heex
> <%= for s <- @snippets, s.is_public, do: s.title %>
> ```
>
> List comprehensions are declarative - you describe what you want, not how to get it.
>
> **Further Reading**:
> - [Comprehensions](https://elixir-lang.org/getting-started/comprehensions.html)

## Summary

In this chapter, we learned:

- Basic iteration with `for`
- Index tracking and first/last detection
- Empty state handling
- Table and grid rendering
- Nested iteration
- Pagination patterns
- Performance considerations

In the next chapter, we'll create reusable Phoenix components.
