# Chapter 6.2: Phoenix Pipelines

Phoenix organizes plugs into pipelines for different request types. In this chapter, we'll explore how to use and configure pipelines in the router.

## What Are Pipelines?

Pipelines are named groups of plugs that run for specific routes:

```elixir
# File: lib/snippetbox_web/router.ex

pipeline :browser do
  plug :accepts, ["html"]
  plug :fetch_session
  plug :fetch_live_flash
  plug :put_root_layout, html: {SnippetboxWeb.Layouts, :root}
  plug :protect_from_forgery
  plug :put_secure_browser_headers
end

pipeline :api do
  plug :accepts, ["json"]
end
```

## The Default Browser Pipeline

Let's understand each plug:

```elixir
pipeline :browser do
  # Accept only HTML format
  plug :accepts, ["html"]

  # Load session data
  plug :fetch_session

  # Load flash messages for LiveView
  plug :fetch_live_flash

  # Set the root layout
  plug :put_root_layout, html: {SnippetboxWeb.Layouts, :root}

  # CSRF protection
  plug :protect_from_forgery

  # Security headers
  plug :put_secure_browser_headers
end
```

### accepts

Checks the Accept header and sets the format:

```elixir
plug :accepts, ["html"]  # Only HTML
plug :accepts, ["html", "json"]  # HTML or JSON
```

### fetch_session

Loads session data into conn:

```elixir
# After fetch_session:
get_session(conn, :user_id)  # Works
```

### protect_from_forgery

Adds CSRF protection:
- Requires valid CSRF token on POST/PUT/PATCH/DELETE
- Token provided by `get_csrf_token()` in forms

### put_secure_browser_headers

Adds security headers:

```
x-frame-options: SAMEORIGIN
x-content-type-options: nosniff
x-xss-protection: 1; mode=block
x-download-options: noopen
x-permitted-cross-domain-policies: none
```

## The API Pipeline

```elixir
pipeline :api do
  plug :accepts, ["json"]
end
```

Simpler because APIs don't need:
- Sessions (use tokens instead)
- CSRF (not applicable to APIs)
- Browser headers

## Using Pipelines

### Basic Usage

```elixir
scope "/", SnippetboxWeb do
  pipe_through :browser

  get "/", PageController, :home
  resources "/snippets", SnippetController
end

scope "/api", SnippetboxWeb.API do
  pipe_through :api

  resources "/snippets", SnippetController
end
```

### Stacking Pipelines

```elixir
scope "/admin", SnippetboxWeb.Admin do
  pipe_through [:browser, :require_admin]

  resources "/snippets", SnippetController
end
```

Order matters - plugs run in order defined.

## Creating Custom Pipelines

### Authentication Pipeline

```elixir
pipeline :auth do
  plug :fetch_current_user
end

pipeline :require_auth do
  plug :require_authenticated_user
end

pipeline :require_admin do
  plug :require_admin_user
end
```

### API Authentication

```elixir
pipeline :api_auth do
  plug :fetch_api_user
end
```

### Using Custom Pipelines

```elixir
scope "/", SnippetboxWeb do
  pipe_through [:browser, :auth]

  get "/", PageController, :home
  resources "/snippets", SnippetController, only: [:index, :show]
end

scope "/", SnippetboxWeb do
  pipe_through [:browser, :auth, :require_auth]

  resources "/snippets", SnippetController, only: [:new, :create, :edit, :update, :delete]
  get "/account", UserController, :show
end

scope "/admin", SnippetboxWeb.Admin do
  pipe_through [:browser, :auth, :require_admin]

  resources "/users", UserController
  resources "/snippets", SnippetController
end
```

## Pipeline Plug Implementations

### fetch_current_user

```elixir
# File: lib/snippetbox_web/plugs/auth.ex

defmodule SnippetboxWeb.Plugs.Auth do
  import Plug.Conn
  import Phoenix.Controller

  alias Snippetbox.Accounts

  def fetch_current_user(conn, _opts) do
    user_id = get_session(conn, :user_id)
    user = user_id && Accounts.get_user(user_id)
    assign(conn, :current_user, user)
  end

  def require_authenticated_user(conn, _opts) do
    if conn.assigns[:current_user] do
      conn
    else
      conn
      |> put_flash(:error, "You must log in to access this page.")
      |> redirect(to: "/login")
      |> halt()
    end
  end

  def require_admin_user(conn, _opts) do
    user = conn.assigns[:current_user]

    if user && user.role == :admin do
      conn
    else
      conn
      |> put_flash(:error, "You must be an admin to access this page.")
      |> redirect(to: "/")
      |> halt()
    end
  end
end
```

Import in router:

```elixir
# File: lib/snippetbox_web/router.ex

import SnippetboxWeb.Plugs.Auth

pipeline :auth do
  plug :fetch_current_user
end
```

### API Token Authentication

```elixir
defmodule SnippetboxWeb.Plugs.APIAuth do
  import Plug.Conn
  import Phoenix.Controller

  def fetch_api_user(conn, _opts) do
    with ["Bearer " <> token] <- get_req_header(conn, "authorization"),
         {:ok, user} <- Snippetbox.Accounts.verify_api_token(token) do
      assign(conn, :current_user, user)
    else
      _ ->
        conn
        |> put_status(:unauthorized)
        |> json(%{error: "Invalid or missing API token"})
        |> halt()
    end
  end
end
```

## Pipeline for Different Layouts

```elixir
pipeline :auth_layout do
  plug :put_layout, html: {SnippetboxWeb.Layouts, :auth}
end

scope "/auth", SnippetboxWeb do
  pipe_through [:browser, :auth_layout]

  get "/login", SessionController, :new
  post "/login", SessionController, :create
  get "/register", UserController, :new
  post "/register", UserController, :create
end
```

## Full Router Example

```elixir
# File: lib/snippetbox_web/router.ex

defmodule SnippetboxWeb.Router do
  use SnippetboxWeb, :router

  import SnippetboxWeb.Plugs.Auth

  pipeline :browser do
    plug :accepts, ["html"]
    plug :fetch_session
    plug :fetch_live_flash
    plug :put_root_layout, html: {SnippetboxWeb.Layouts, :root}
    plug :protect_from_forgery
    plug :put_secure_browser_headers
  end

  pipeline :api do
    plug :accepts, ["json"]
  end

  pipeline :auth do
    plug :fetch_current_user
  end

  pipeline :require_auth do
    plug :require_authenticated_user
  end

  pipeline :require_admin do
    plug :require_admin_user
  end

  # Public browser routes
  scope "/", SnippetboxWeb do
    pipe_through [:browser, :auth]

    get "/", PageController, :home
    get "/about", PageController, :about
    resources "/snippets", SnippetController, only: [:index, :show]
  end

  # Auth routes
  scope "/", SnippetboxWeb do
    pipe_through [:browser]

    get "/login", SessionController, :new
    post "/login", SessionController, :create
    delete "/logout", SessionController, :delete
    get "/register", UserController, :new
    post "/register", UserController, :create
  end

  # Authenticated routes
  scope "/", SnippetboxWeb do
    pipe_through [:browser, :auth, :require_auth]

    resources "/snippets", SnippetController, only: [:new, :create, :edit, :update, :delete]
    get "/account", UserController, :show
    put "/account", UserController, :update
  end

  # Admin routes
  scope "/admin", SnippetboxWeb.Admin, as: :admin do
    pipe_through [:browser, :auth, :require_admin]

    get "/", DashboardController, :index
    resources "/users", UserController
    resources "/snippets", SnippetController
  end

  # API routes
  scope "/api/v1", SnippetboxWeb.API.V1, as: :api_v1 do
    pipe_through :api

    resources "/snippets", SnippetController, only: [:index, :show, :create]
  end
end
```

> **FP Concept: Function Composition**
>
> Pipelines are function composition:
>
> ```elixir
> pipe_through [:browser, :auth, :require_auth]
>
> # Is like:
> conn
> |> browser_plug1()
> |> browser_plug2()
> |> auth_plug()
> |> require_auth_plug()
> ```
>
> Each plug transforms the conn, and the result is passed to the next plug.
>
> **Further Reading**:
> - [Phoenix Router](https://hexdocs.pm/phoenix/routing.html)

## Summary

In this chapter, we learned:

- Default browser and API pipelines
- Creating custom pipelines
- Stacking multiple pipelines
- Implementing authentication plugs
- Organizing routes with pipelines

In the next chapter, we'll create custom plugs from scratch.
