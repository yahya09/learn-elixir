# Chapter 13: Testing

Testing is a first-class citizen in Elixir and Phoenix. In this chapter, we'll explore comprehensive testing strategies for Phoenix applications.

## What You'll Learn

- Unit testing with ExUnit
- Controller and integration testing
- LiveView testing
- Database testing strategies
- Test organization and best practices

## Chapter Structure

This chapter covers:

- **13.1 Unit Testing** - Testing modules and functions
- **13.2 Controller Testing** - Testing HTTP endpoints
- **13.3 Integration Testing** - End-to-end testing
- **13.4 LiveView Testing** - Testing LiveView components
- **13.5 Database Testing** - Ecto and sandbox testing
- **13.6 Best Practices** - Coverage and organization

## Testing in Elixir

ExUnit is Elixir's built-in test framework:

```elixir
# Run all tests
mix test

# Run specific file
mix test test/snippetbox/snippets_test.exs

# Run specific test
mix test test/snippetbox/snippets_test.exs:42

# Run with coverage
mix test --cover

# Run in watch mode (with mix_test_watch)
mix test.watch
```

## Test Structure

```
test/
├── snippetbox/                    # Context tests
│   ├── accounts_test.exs
│   └── snippets_test.exs
├── snippetbox_web/
│   ├── controllers/              # Controller tests
│   │   ├── page_controller_test.exs
│   │   └── snippet_controller_test.exs
│   ├── live/                     # LiveView tests
│   │   └── snippet_live_test.exs
│   └── views/                    # View tests (if any)
├── support/                      # Test helpers
│   ├── conn_case.ex
│   ├── data_case.ex
│   ├── fixtures/
│   │   └── accounts_fixtures.ex
│   └── channel_case.ex
└── test_helper.exs               # Test configuration
```

## Test Configuration

```elixir
# File: test/test_helper.exs

ExUnit.start()
Ecto.Adapters.SQL.Sandbox.mode(Snippetbox.Repo, :manual)
```

```elixir
# File: config/test.exs

import Config

# Configure your database for tests
config :snippetbox, Snippetbox.Repo,
  username: "postgres",
  password: "postgres",
  hostname: "localhost",
  database: "snippetbox_test#{System.get_env("MIX_TEST_PARTITION")}",
  pool: Ecto.Adapters.SQL.Sandbox,
  pool_size: 10

# Faster password hashing for tests
config :bcrypt_elixir, :log_rounds, 1

# Disable Swoosh API client
config :swoosh, :api_client, false

# Print only warnings and errors during test
config :logger, level: :warning

# Initialize plugs at runtime for faster test compilation
config :phoenix, :plug_init_mode, :runtime
```

## Test Cases

Phoenix provides specialized test case modules:

### DataCase

For testing contexts and database operations:

```elixir
# File: test/support/data_case.ex

defmodule Snippetbox.DataCase do
  use ExUnit.CaseTemplate

  using do
    quote do
      alias Snippetbox.Repo

      import Ecto
      import Ecto.Changeset
      import Ecto.Query
      import Snippetbox.DataCase
    end
  end

  setup tags do
    Snippetbox.DataCase.setup_sandbox(tags)
    :ok
  end

  def setup_sandbox(tags) do
    pid = Ecto.Adapters.SQL.Sandbox.start_owner!(Snippetbox.Repo, shared: not tags[:async])
    on_exit(fn -> Ecto.Adapters.SQL.Sandbox.stop_owner(pid) end)
  end

  def errors_on(changeset) do
    Ecto.Changeset.traverse_errors(changeset, fn {message, opts} ->
      Regex.replace(~r"%{(\w+)}", message, fn _, key ->
        opts |> Keyword.get(String.to_existing_atom(key), key) |> to_string()
      end)
    end)
  end
end
```

### ConnCase

For testing controllers:

```elixir
# File: test/support/conn_case.ex

defmodule SnippetboxWeb.ConnCase do
  use ExUnit.CaseTemplate

  using do
    quote do
      @endpoint SnippetboxWeb.Endpoint

      use SnippetboxWeb, :verified_routes

      import Plug.Conn
      import Phoenix.ConnTest
      import SnippetboxWeb.ConnCase
    end
  end

  setup tags do
    Snippetbox.DataCase.setup_sandbox(tags)
    {:ok, conn: Phoenix.ConnTest.build_conn()}
  end

  def register_and_log_in_user(%{conn: conn}) do
    user = Snippetbox.AccountsFixtures.user_fixture()
    %{conn: log_in_user(conn, user), user: user}
  end

  def log_in_user(conn, user) do
    token = Snippetbox.Accounts.generate_user_session_token(user)

    conn
    |> Phoenix.ConnTest.init_test_session(%{})
    |> Plug.Conn.put_session(:user_token, token)
  end
end
```

## Fixtures

```elixir
# File: test/support/fixtures/accounts_fixtures.ex

defmodule Snippetbox.AccountsFixtures do
  def unique_user_email, do: "user#{System.unique_integer()}@example.com"
  def valid_user_password, do: "hello world!"

  def valid_user_attributes(attrs \\ %{}) do
    Enum.into(attrs, %{
      email: unique_user_email(),
      password: valid_user_password()
    })
  end

  def user_fixture(attrs \\ %{}) do
    {:ok, user} =
      attrs
      |> valid_user_attributes()
      |> Snippetbox.Accounts.register_user()

    user
  end
end
```

## Quick Test Example

```elixir
# File: test/snippetbox/snippets_test.exs

defmodule Snippetbox.SnippetsTest do
  use Snippetbox.DataCase

  alias Snippetbox.Snippets

  describe "snippets" do
    alias Snippetbox.Snippets.Snippet

    import Snippetbox.SnippetsFixtures

    test "list_snippets/0 returns all snippets" do
      snippet = snippet_fixture()
      assert Snippets.list_snippets() == [snippet]
    end

    test "get_snippet!/1 returns the snippet with given id" do
      snippet = snippet_fixture()
      assert Snippets.get_snippet!(snippet.id) == snippet
    end

    test "create_snippet/1 with valid data creates a snippet" do
      valid_attrs = %{title: "Test", content: "Code", language: "elixir"}

      assert {:ok, %Snippet{} = snippet} = Snippets.create_snippet(valid_attrs)
      assert snippet.title == "Test"
      assert snippet.content == "Code"
      assert snippet.language == "elixir"
    end

    test "create_snippet/1 with invalid data returns error changeset" do
      assert {:error, %Ecto.Changeset{}} = Snippets.create_snippet(%{})
    end
  end
end
```

## Test Tags

```elixir
# Run async tests in parallel
@tag :async
test "async test" do
  # ...
end

# Skip tests
@tag :skip
test "skipped test" do
  # ...
end

# External service tests
@tag :external
test "calls external API" do
  # ...
end

# Run only external tests
# mix test --only external
```

Let's explore each testing strategy in detail.
