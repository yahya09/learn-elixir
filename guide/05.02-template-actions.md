# Chapter 5.2: Template Actions

In this chapter, we'll create templates for all CRUD actions - index, show, new, edit, and form handling.

## Standard CRUD Templates

A typical resource needs these templates:

| Template | Purpose | Data |
|----------|---------|------|
| `index.html.heex` | List all records | `@snippets` |
| `show.html.heex` | Display one record | `@snippet` |
| `new.html.heex` | Form for new record | `@changeset` |
| `edit.html.heex` | Form to edit record | `@snippet`, `@changeset` |
| `_form.html.heex` | Shared form partial | `@changeset`, `@action` |

## Index Template

```heex
<%# File: lib/snippetbox_web/controllers/snippet_html/index.html.heex %>

<div class="page-header">
  <h1>Snippets</h1>
  <.link href={~p"/snippets/new"} class="btn btn-primary">
    New Snippet
  </.link>
</div>

<div class="filters">
  <form action={~p"/snippets"} method="get">
    <select name="language" onchange="this.form.submit()">
      <option value="">All Languages</option>
      <%= for lang <- ["elixir", "ruby", "python", "javascript"] do %>
        <option value={lang} selected={@language == lang}><%= lang %></option>
      <% end %>
    </select>
  </form>
</div>

<%= if Enum.empty?(@snippets) do %>
  <div class="empty-state">
    <h2>No snippets found</h2>
    <p>Create your first snippet to get started.</p>
    <.link href={~p"/snippets/new"} class="btn">Create Snippet</.link>
  </div>
<% else %>
  <table class="table">
    <thead>
      <tr>
        <th>Title</th>
        <th>Language</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <%= for snippet <- @snippets do %>
        <tr>
          <td>
            <.link href={~p"/snippets/#{snippet}"}><%= snippet.title %></.link>
          </td>
          <td><%= snippet.language %></td>
          <td><%= time_ago(snippet.inserted_at) %></td>
          <td class="actions">
            <.link href={~p"/snippets/#{snippet}/edit"}>Edit</.link>
            <.link href={~p"/snippets/#{snippet}"} method="delete"
                   data-confirm="Are you sure?">
              Delete
            </.link>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>

<%= if @total_pages > 1 do %>
  <nav class="pagination">
    <%= if @page > 1 do %>
      <.link href={~p"/snippets?#{[page: @page - 1, language: @language]}"}>
        Previous
      </.link>
    <% end %>

    <span>Page <%= @page %> of <%= @total_pages %></span>

    <%= if @page < @total_pages do %>
      <.link href={~p"/snippets?#{[page: @page + 1, language: @language]}"}>
        Next
      </.link>
    <% end %>
  </nav>
<% end %>
```

## Show Template

```heex
<%# File: lib/snippetbox_web/controllers/snippet_html/show.html.heex %>

<article class="snippet-detail">
  <header>
    <div class="title-row">
      <h1><%= @snippet.title %></h1>
      <%= if @snippet.is_public do %>
        <span class="badge badge-success">Public</span>
      <% else %>
        <span class="badge badge-secondary">Private</span>
      <% end %>
    </div>

    <div class="meta">
      <span class="language">
        <strong>Language:</strong> <%= @snippet.language %>
      </span>
      <span class="created">
        <strong>Created:</strong>
        <time datetime={DateTime.to_iso8601(@snippet.inserted_at)}>
          <%= format_date(@snippet.inserted_at) %>
        </time>
      </span>
      <%= if @snippet.expires_at do %>
        <span class="expires">
          <strong>Expires:</strong>
          <time datetime={DateTime.to_iso8601(@snippet.expires_at)}>
            <%= format_date(@snippet.expires_at) %>
          </time>
        </span>
      <% end %>
    </div>
  </header>

  <section class="content">
    <div class="code-header">
      <span><%= @snippet.language %></span>
      <button class="btn-copy" data-clipboard-target="#snippet-code">
        Copy
      </button>
    </div>
    <pre id="snippet-code"><code class={"language-#{@snippet.language}"}><%= @snippet.content %></code></pre>
  </section>

  <footer class="actions">
    <.link href={~p"/snippets/#{@snippet}/edit"} class="btn btn-secondary">
      Edit
    </.link>
    <.link href={~p"/snippets/#{@snippet}"} method="delete"
           class="btn btn-danger"
           data-confirm="Are you sure you want to delete this snippet?">
      Delete
    </.link>
    <.link href={~p"/snippets"} class="btn btn-outline">
      Back to Snippets
    </.link>
  </footer>
</article>
```

## New Template

```heex
<%# File: lib/snippetbox_web/controllers/snippet_html/new.html.heex %>

<div class="page-header">
  <h1>New Snippet</h1>
</div>

<.form for={@changeset} action={~p"/snippets"} class="snippet-form">
  <%= render "_form.html", changeset: @changeset %>

  <div class="form-actions">
    <button type="submit" class="btn btn-primary">Create Snippet</button>
    <.link href={~p"/snippets"} class="btn btn-outline">Cancel</.link>
  </div>
</.form>
```

## Edit Template

```heex
<%# File: lib/snippetbox_web/controllers/snippet_html/edit.html.heex %>

<div class="page-header">
  <h1>Edit Snippet</h1>
</div>

<.form for={@changeset} action={~p"/snippets/#{@snippet}"} method="put" class="snippet-form">
  <%= render "_form.html", changeset: @changeset %>

  <div class="form-actions">
    <button type="submit" class="btn btn-primary">Update Snippet</button>
    <.link href={~p"/snippets/#{@snippet}"} class="btn btn-outline">Cancel</.link>
  </div>
</.form>

<div class="danger-zone">
  <h3>Danger Zone</h3>
  <.link href={~p"/snippets/#{@snippet}"} method="delete"
         class="btn btn-danger"
         data-confirm="This action cannot be undone. Are you sure?">
    Delete this snippet
  </.link>
</div>
```

## Form Partial

```heex
<%# File: lib/snippetbox_web/controllers/snippet_html/_form.html.heex %>

<%= if @changeset.action do %>
  <div class="alert alert-danger">
    <p>Oops, something went wrong! Please check the errors below.</p>
  </div>
<% end %>

<div class="form-group">
  <label for="snippet_title">Title</label>
  <input type="text"
         name="snippet[title]"
         id="snippet_title"
         value={@changeset.changes[:title] || @changeset.data.title}
         class={"form-control #{if @changeset.errors[:title], do: "is-invalid"}"}
         required />
  <%= if error = @changeset.errors[:title] do %>
    <span class="invalid-feedback"><%= translate_error(error) %></span>
  <% end %>
</div>

<div class="form-group">
  <label for="snippet_language">Language</label>
  <select name="snippet[language]"
          id="snippet_language"
          class="form-control">
    <%= for lang <- Snippetbox.Snippets.Snippet.supported_languages() do %>
      <option value={lang}
              selected={(@changeset.changes[:language] || @changeset.data.language) == lang}>
        <%= lang %>
      </option>
    <% end %>
  </select>
</div>

<div class="form-group">
  <label for="snippet_content">Content</label>
  <textarea name="snippet[content]"
            id="snippet_content"
            rows="15"
            class={"form-control #{if @changeset.errors[:content], do: "is-invalid"}"}
            required><%= @changeset.changes[:content] || @changeset.data.content %></textarea>
  <%= if error = @changeset.errors[:content] do %>
    <span class="invalid-feedback"><%= translate_error(error) %></span>
  <% end %>
</div>

<div class="form-group">
  <label for="snippet_expires_at">Expires At (optional)</label>
  <input type="datetime-local"
         name="snippet[expires_at]"
         id="snippet_expires_at"
         value={format_datetime_local(@changeset.changes[:expires_at] || @changeset.data.expires_at)}
         class="form-control" />
</div>

<div class="form-check">
  <input type="hidden" name="snippet[is_public]" value="false" />
  <input type="checkbox"
         name="snippet[is_public]"
         id="snippet_is_public"
         value="true"
         checked={@changeset.changes[:is_public] || @changeset.data.is_public}
         class="form-check-input" />
  <label for="snippet_is_public" class="form-check-label">
    Make this snippet public
  </label>
</div>
```

## Controller Actions

```elixir
# File: lib/snippetbox_web/controllers/snippet_controller.ex

defmodule SnippetboxWeb.SnippetController do
  use SnippetboxWeb, :controller

  alias Snippetbox.Snippets
  alias Snippetbox.Snippets.Snippet

  def index(conn, params) do
    page = String.to_integer(params["page"] || "1")
    language = params["language"]

    %{snippets: snippets, total_pages: total_pages} =
      Snippets.list_snippets(page: page, language: language)

    render(conn, :index,
      snippets: snippets,
      page: page,
      total_pages: total_pages,
      language: language
    )
  end

  def show(conn, %{"id" => id}) do
    snippet = Snippets.get_snippet!(id)
    render(conn, :show, snippet: snippet)
  end

  def new(conn, _params) do
    changeset = Snippets.change_snippet(%Snippet{})
    render(conn, :new, changeset: changeset)
  end

  def create(conn, %{"snippet" => snippet_params}) do
    case Snippets.create_snippet(snippet_params) do
      {:ok, snippet} ->
        conn
        |> put_flash(:info, "Snippet created successfully.")
        |> redirect(to: ~p"/snippets/#{snippet}")

      {:error, %Ecto.Changeset{} = changeset} ->
        render(conn, :new, changeset: changeset)
    end
  end

  def edit(conn, %{"id" => id}) do
    snippet = Snippets.get_snippet!(id)
    changeset = Snippets.change_snippet(snippet)
    render(conn, :edit, snippet: snippet, changeset: changeset)
  end

  def update(conn, %{"id" => id, "snippet" => snippet_params}) do
    snippet = Snippets.get_snippet!(id)

    case Snippets.update_snippet(snippet, snippet_params) do
      {:ok, snippet} ->
        conn
        |> put_flash(:info, "Snippet updated successfully.")
        |> redirect(to: ~p"/snippets/#{snippet}")

      {:error, %Ecto.Changeset{} = changeset} ->
        render(conn, :edit, snippet: snippet, changeset: changeset)
    end
  end

  def delete(conn, %{"id" => id}) do
    snippet = Snippets.get_snippet!(id)
    {:ok, _snippet} = Snippets.delete_snippet(snippet)

    conn
    |> put_flash(:info, "Snippet deleted successfully.")
    |> redirect(to: ~p"/snippets")
  end
end
```

## View Helpers

```elixir
# File: lib/snippetbox_web/controllers/snippet_html.ex

defmodule SnippetboxWeb.SnippetHTML do
  use SnippetboxWeb, :html

  embed_templates "snippet_html/*"

  def format_date(nil), do: ""
  def format_date(datetime) do
    Calendar.strftime(datetime, "%B %d, %Y at %H:%M")
  end

  def format_datetime_local(nil), do: ""
  def format_datetime_local(datetime) do
    datetime
    |> DateTime.to_naive()
    |> NaiveDateTime.to_iso8601()
    |> String.slice(0, 16)
  end

  def time_ago(datetime) do
    diff = DateTime.diff(DateTime.utc_now(), datetime, :second)

    cond do
      diff < 60 -> "just now"
      diff < 3600 -> "#{div(diff, 60)} minutes ago"
      diff < 86400 -> "#{div(diff, 3600)} hours ago"
      diff < 604800 -> "#{div(diff, 86400)} days ago"
      true -> format_date(datetime)
    end
  end

  def translate_error({msg, opts}) do
    Enum.reduce(opts, msg, fn {key, value}, acc ->
      String.replace(acc, "%{#{key}}", fn _ -> to_string(value) end)
    end)
  end
end
```

> **FP Concept: Templates as Functions**
>
> Each template is essentially a function:
>
> ```
> index(assigns) → HTML
> show(assigns) → HTML
> _form(assigns) → HTML fragment
> ```
>
> The partial `_form` is a shared function used by both `new` and `edit` templates, following the DRY principle through function composition.
>
> **Further Reading**:
> - [Phoenix Generators](https://hexdocs.pm/phoenix/Mix.Tasks.Phx.Gen.Html.html)

## Summary

In this chapter, we created:

- Index template with filtering and pagination
- Show template with detailed record display
- New and Edit templates with forms
- Shared form partial
- Supporting controller and view code

In the next chapter, we'll focus on iterating over collections with more advanced patterns.
