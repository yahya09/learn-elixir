# Chapter 14.1: Elixir Releases

Releases are self-contained packages that include your application, its dependencies, and the Erlang runtime. In this chapter, we'll explore building and configuring releases.

## What is a Release?

A release is a deployable artifact containing:

- Your compiled application
- All dependencies
- Erlang/OTP runtime (ERTS)
- Boot scripts and configuration

```
_build/prod/rel/snippetbox/
├── bin/
│   └── snippetbox         # CLI entry point
├── lib/
│   ├── snippetbox-0.1.0/  # Your app
│   ├── phoenix-1.7.x/     # Phoenix
│   └── ecto-3.x/          # Dependencies
├── releases/
│   └── 0.1.0/
│       ├── elixir         # Elixir version
│       ├── env.sh         # Environment script
│       ├── remote.sh      # Remote console script
│       └── vm.args        # BEAM VM arguments
└── erts-14.0/             # Erlang runtime
```

## Building a Release

### Basic Release

```bash
# Build production release
MIX_ENV=prod mix release

# Output
* Release created at _build/prod/rel/snippetbox
```

### Release Configuration

```elixir
# File: mix.exs

def project do
  [
    app: :snippetbox,
    version: "0.1.0",
    elixir: "~> 1.16",
    releases: [
      snippetbox: [
        include_executables_for: [:unix],
        applications: [runtime_tools: :permanent]
      ]
    ]
  ]
end
```

### Custom Release Options

```elixir
# File: mix.exs

releases: [
  snippetbox: [
    version: {:from_app, :snippetbox},
    include_executables_for: [:unix, :windows],
    include_erts: true,
    strip_beams: true,
    cookie: "super_secret_cookie",
    steps: [:assemble, :tar]
  ]
]
```

## Runtime Configuration

### config/runtime.exs

```elixir
# File: config/runtime.exs

import Config

if config_env() == :prod do
  database_url =
    System.get_env("DATABASE_URL") ||
      raise """
      environment variable DATABASE_URL is missing.
      For example: ecto://USER:PASS@HOST/DATABASE
      """

  config :snippetbox, Snippetbox.Repo,
    url: database_url,
    pool_size: String.to_integer(System.get_env("POOL_SIZE") || "10"),
    ssl: true,
    ssl_opts: [
      verify: :verify_peer,
      cacerts: :public_key.cacerts_get(),
      server_name_indication: String.to_charlist(System.get_env("DATABASE_HOST")),
      customize_hostname_check: [
        match_fun: :public_key.pkix_verify_hostname_match_fun(:https)
      ]
    ]

  secret_key_base =
    System.get_env("SECRET_KEY_BASE") ||
      raise """
      environment variable SECRET_KEY_BASE is missing.
      You can generate one by calling: mix phx.gen.secret
      """

  host = System.get_env("PHX_HOST") || "example.com"
  port = String.to_integer(System.get_env("PORT") || "4000")

  config :snippetbox, SnippetboxWeb.Endpoint,
    url: [host: host, port: 443, scheme: "https"],
    http: [
      ip: {0, 0, 0, 0, 0, 0, 0, 0},
      port: port
    ],
    secret_key_base: secret_key_base,
    server: true

  # Email configuration
  config :snippetbox, Snippetbox.Mailer,
    adapter: Swoosh.Adapters.Postmark,
    api_key: System.get_env("POSTMARK_API_KEY")
end
```

## Release Commands

### Running the Application

```bash
# Start in foreground
bin/snippetbox start

# Start in background (daemon)
bin/snippetbox daemon

# Start with interactive console
bin/snippetbox start_iex

# Stop daemon
bin/snippetbox stop

# Restart daemon
bin/snippetbox restart

# Check if running
bin/snippetbox pid
```

### Remote Console

```bash
# Connect to running application
bin/snippetbox remote

# In the console
iex> Snippetbox.Repo.all(Snippetbox.Snippets.Snippet)
iex> :observer.start()  # Start Observer GUI
```

### Running Migrations

```elixir
# File: lib/snippetbox/release.ex

defmodule Snippetbox.Release do
  @moduledoc """
  Release tasks for running migrations and seeds.
  """

  @app :snippetbox

  def migrate do
    load_app()

    for repo <- repos() do
      {:ok, _, _} = Ecto.Migrator.with_repo(repo, &Ecto.Migrator.run(&1, :up, all: true))
    end
  end

  def rollback(repo, version) do
    load_app()
    {:ok, _, _} = Ecto.Migrator.with_repo(repo, &Ecto.Migrator.run(&1, :down, to: version))
  end

  def seed do
    load_app()

    for repo <- repos() do
      {:ok, _, _} = Ecto.Migrator.with_repo(repo, fn _ ->
        Code.eval_file(Path.join([:code.priv_dir(@app), "repo", "seeds.exs"]))
      end)
    end
  end

  defp repos do
    Application.fetch_env!(@app, :ecto_repos)
  end

  defp load_app do
    Application.load(@app)
  end
end
```

```bash
# Run migrations
bin/snippetbox eval "Snippetbox.Release.migrate()"

# Run seeds
bin/snippetbox eval "Snippetbox.Release.seed()"

# Rollback to version
bin/snippetbox eval "Snippetbox.Release.rollback(Snippetbox.Repo, 20240101000000)"
```

## Environment Scripts

### rel/env.sh.eex

```bash
#!/bin/sh

# Custom environment setup
export RELEASE_DISTRIBUTION=name
export RELEASE_NODE=snippetbox@127.0.0.1

# Load secrets from file if present
if [ -f /run/secrets/env ]; then
  export $(cat /run/secrets/env | xargs)
fi

# Set ERL_AFLAGS for better observability
export ERL_AFLAGS="-kernel shell_history enabled"
```

### rel/vm.args.eex

```
## VM options

## Name of the node
-name <%= @release.name %>@127.0.0.1

## Cookie for distributed Erlang
-setcookie <%= @release.cookie %>

## Heartbeat monitoring
-heart

## Maximum number of processes
+P 1000000

## Maximum number of ports
+Q 65536

## Scheduler settings
+K true
+A 32
+SDio 32

## Memory
+MBas aobf
+MBlmbcs 512

## Garbage collection settings
+sbwt very_long
+swt very_low
```

## Asset Compilation

```bash
# Compile assets before building release
MIX_ENV=prod mix assets.deploy

# This runs:
# 1. esbuild for JavaScript
# 2. tailwind for CSS
# 3. phx.digest for cache manifests
```

### Asset Pipeline Configuration

```elixir
# File: config/config.exs

config :esbuild,
  version: "0.17.11",
  default: [
    args: ~w(js/app.js --bundle --target=es2017 --outdir=../priv/static/assets --external:/fonts/* --external:/images/*),
    cd: Path.expand("../assets", __DIR__),
    env: %{"NODE_PATH" => Path.expand("../deps", __DIR__)}
  ]

config :tailwind,
  version: "3.4.0",
  default: [
    args: ~w(--config=tailwind.config.js --input=css/app.css --output=../priv/static/assets/app.css),
    cd: Path.expand("../assets", __DIR__)
  ]
```

## Overlays

Add extra files to releases:

```elixir
# File: mix.exs

releases: [
  snippetbox: [
    overlays: ["rel/overlays"]
  ]
]
```

```bash
# rel/overlays/
# Files here are copied to release root

rel/overlays/
├── bin/
│   └── migrate     # Custom migration script
└── etc/
    └── nginx.conf  # Nginx config template
```

## Building for Different Targets

### Cross-Compilation with Burrito

```elixir
# For native executables
{:burrito, "~> 1.0"}
```

### Multi-Platform Docker

```bash
# Build for multiple platforms
docker buildx build --platform linux/amd64,linux/arm64 -t myapp .
```

## Deploying a Release

### Basic Deploy Script

```bash
#!/bin/bash
# deploy.sh

set -e

SERVER="deploy@production-server"
APP_DIR="/opt/snippetbox"
RELEASE_DIR="_build/prod/rel/snippetbox"

echo "Building release..."
MIX_ENV=prod mix deps.get --only prod
MIX_ENV=prod mix assets.deploy
MIX_ENV=prod mix release --overwrite

echo "Deploying to server..."
rsync -avz --delete $RELEASE_DIR/ $SERVER:$APP_DIR/

echo "Running migrations..."
ssh $SERVER "$APP_DIR/bin/snippetbox eval 'Snippetbox.Release.migrate()'"

echo "Restarting application..."
ssh $SERVER "sudo systemctl restart snippetbox"

echo "Deploy complete!"
```

### Systemd Service

```ini
# /etc/systemd/system/snippetbox.service

[Unit]
Description=Snippetbox Phoenix Application
After=network.target postgresql.service

[Service]
Type=exec
User=deploy
Group=deploy
WorkingDirectory=/opt/snippetbox
Environment=MIX_ENV=prod
Environment=PORT=4000
EnvironmentFile=/opt/snippetbox/.env
ExecStart=/opt/snippetbox/bin/snippetbox start
ExecStop=/opt/snippetbox/bin/snippetbox stop
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
```

```bash
# Enable and start
sudo systemctl enable snippetbox
sudo systemctl start snippetbox
sudo systemctl status snippetbox
```

> **FP Concept: Immutable Releases**
>
> Releases are immutable artifacts:
>
> ```elixir
> # Each release is a complete snapshot
> # No shared state between releases
> # Rollback = deploy previous release
>
> releases/
> ├── 0.1.0/  # Version 1
> ├── 0.2.0/  # Version 2
> └── 0.3.0/  # Current
>
> # To rollback: symlink or deploy 0.2.0
> ```
>
> This aligns with functional principles of immutability.

## Summary

In this chapter, we learned:

- What releases are and why to use them
- Building releases with Mix
- Runtime configuration
- Release commands (start, migrate, remote)
- Environment and VM configuration
- Asset compilation
- Deployment strategies

In the next chapter, we'll explore Docker containerization.
